<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Grade Tracking with District Classification</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 2000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
            padding: 25px 30px;
            border-bottom: 3px solid #daa520;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        h1 i {
            color: #333;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.8;
            font-weight: 500;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            min-height: 600px;
        }
        
        .panel {
            padding: 25px;
            flex: 1;
            min-width: 300px;
        }
        
        .left-panel {
            background-color: #f9f9f9;
            border-right: 1px solid #eee;
            width: 35%;
        }
        
        .right-panel {
            background-color: #fff;
            display: flex;
            flex-direction: column;
            width: 65%;
        }
        
        h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffd700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 i {
            color: #daa520;
        }
        
        .sku-list-container {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
            background-color: #fff;
        }
        
        .sku-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sku-item.gold {
            border-left: 4px solid #ffd700;
            background-color: #fffef0;
        }
        
        .sku-item.silver {
            border-left: 4px solid #c0c0c0;
            background-color: #f8f8f8;
        }

        .sku-item.bronze {
            border-left: 4px solid #cd7f32;
            background-color: #fff3e6;
        }
        
        .sku-item.grease {
            border-left: 4px solid #8B4513;
            background-color: #f8f4f0;
        }
        
        .sku-item.hydraulic {
            border-left: 4px solid #0066cc;
            background-color: #e6f0fa;
        }
        
        .sku-item.def {
            border-left: 4px solid #228B22;
            background-color: #f0f8f0;
        }
        
        .sku-item.green {
            border-left: 4px solid #2E8B57;
            background-color: #f0fff0;
        }
        
        .sku-item.other {
            border-left: 4px solid #666;
            background-color: #f0f0f0;
        }
        
        .sku-name {
            font-size: 0.8rem;
            color: #666;
            font-style: italic;
            margin-top: 2px;
        }
        
        .sku-count {
            display: inline-block;
            background-color: #ffd700;
            color: #333;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-left: 10px;
            font-weight: bold;
        }
        
        .file-upload-area {
            border: 2px dashed #daa520;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            background-color: #fffef5;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            background-color: #fffce6;
            border-color: #c19500;
        }
        
        .file-upload-area i {
            font-size: 2.5rem;
            color: #ffd700;
            margin-bottom: 10px;
        }
        
        .file-upload-area h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .file-upload-area p {
            color: #666;
            font-size: 0.9rem;
        }
        
        #fileInput {
            display: none;
        }
        
        .mapping-section {
            margin-top: 20px;
        }
        
        .mapping-control {
            margin-bottom: 12px;
        }
        
        .mapping-control label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #444;
        }
        
        .mapping-control select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            font-size: 1rem;
            color: #333;
        }
        
        .filters-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }
        
        .filters-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #444;
            font-size: 0.9rem;
        }
        
        .filter-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            font-size: 0.9rem;
        }
        
        .reset-filters {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .reset-filters:hover {
            background-color: #5a6268;
        }
        
        .preview-table-container {
            flex: 1;
            overflow: auto;
            margin-bottom: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            max-height: 400px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .preview-table th {
            background-color: #ffd700;
            color: #333;
            padding: 12px 15px;
            text-align: left;
            position: sticky;
            top: 0;
        }
        
        .preview-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .preview-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .preview-table tr:hover {
            background-color: #fff8dc;
        }
        
        .actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            min-width: 160px;
        }
        
        .btn-primary {
            background-color: #ffd700;
            color: #333;
        }
        
        .btn-primary:hover {
            background-color: #e6c200;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
        }
        
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        .btn-export {
            background-color: #28a745;
            color: white;
        }
        
        .btn-export:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }
        
        .btn-pdf {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-pdf:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
        .btn-sales {
            background-color: #007bff;
            color: white;
        }
        
        .btn-sales:hover {
            background-color: #0069d9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }
        
        .btn-purchase {
            background-color: #6f42c1;
            color: white;
        }
        
        .btn-purchase:hover {
            background-color: #5e34b1;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(111, 66, 193, 0.3);
        }
        
        .btn-report {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-report:hover {
            background-color: #138496;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
        }
        
        .btn-text {
            background-color: #6c5ce7;
            color: white;
        }
        
        .btn-text:hover {
            background-color: #5a4bd1;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 92, 231, 0.3);
        }
        
        .validation-result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
            border-left: 4px solid #ffd700;
        }
        
        .validation-result h3 {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .validation-item {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .validation-item i {
            color: #4CAF50;
        }
        
        .validation-item.error i {
            color: #f44336;
        }
        
        .validation-item.warning i {
            color: #ffc107;
        }
        
        .totals-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .total-box {
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .total-box.gold {
            background-color: #fff8dc;
            border-color: #ffd700;
        }
        
        .total-box.silver {
            background-color: #f8f8f8;
            border-color: #c0c0c0;
        }

        .total-box.bronze {
            background-color: #fff3e6;
            border-color: #cd7f32;
        }
        
        .total-box.grease {
            background-color: #f8f4f0;
            border-color: #8B4513;
        }
        
        .total-box.hydraulic {
            background-color: #e6f0fa;
            border-color: #0066cc;
        }
        
        .total-box.def {
            background-color: #f0f8f0;
            border-color: #228B22;
        }
        
        .total-box.green {
            background-color: #f0fff0;
            border-color: #2E8B57;
        }
        
        .total-box.other {
            background-color: #f0f0f0;
            border-color: #666;
        }
        
        .total-box.franky {
            background-color: #e3f2fd;
            border-color: #1976d2;
        }
        
        .total-box.kyrpad {
            background-color: #f3e5f5;
            border-color: #7b1fa2;
        }
        
        .total-box.others-district {
            background-color: #fff3e0;
            border-color: #e65100;
        }
        
        .total-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .total-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }
        
        .total-value small {
            font-size: 0.9rem;
            color: #666;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
        }
        
        .status-indicator {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-ready {
            background-color: #d4edda;
            color: #155724;
        }
        
        .sku-info-container {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .sku-info-container h4 {
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .grade-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .grade-gold {
            background-color: #fff8dc;
            color: #b8860b;
            border: 1px solid #ffd700;
        }
        
        .grade-silver {
            background-color: #f8f8f8;
            color: #6c757d;
            border: 1px solid #c0c0c0;
        }

        .grade-bronze {
            background-color: #fff3e6;
            color: #b85e00;
            border: 1px solid #cd7f32;
        }
        
        .grade-grease {
            background-color: #f8f4f0;
            color: #8B4513;
            border: 1px solid #a0522d;
        }
        
        .grade-hydraulic {
            background-color: #e6f0fa;
            color: #0066cc;
            border: 1px solid #0066cc;
        }
        
        .grade-def {
            background-color: #f0f8f0;
            color: #228B22;
            border: 1px solid #228B22;
        }
        
        .grade-green {
            background-color: #f0fff0;
            color: #2E8B57;
            border: 1px solid #2E8B57;
        }
        
        .grade-other {
            background-color: #f0f0f0;
            color: #666;
            border: 1px solid #ccc;
        }
        
        .district-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .district-franky {
            background-color: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }
        
        .district-kyrpad {
            background-color: #f3e5f5;
            color: #7b1fa2;
            border: 1px solid #e1bee7;
        }
        
        .district-others {
            background-color: #fff3e0;
            color: #e65100;
            border: 1px solid #ffe0b2;
        }
        
        .multi-select-container {
            position: relative;
            width: 100%;
        }
        
        .multi-select-header {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .multi-select-header:hover {
            border-color: #aaa;
        }
        
        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 5px;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
        }
        
        .multi-select-dropdown.show {
            display: block;
        }
        
        .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .multi-select-option:hover {
            background-color: #f5f5f5;
        }
        
        .multi-select-option input[type="checkbox"] {
            margin: 0;
        }
        
        .multi-select-option label {
            cursor: pointer;
            flex: 1;
            font-size: 0.9rem;
        }
        
        .selected-count {
            background-color: #ffd700;
            color: #333;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .select-all-btn, .clear-all-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background-color: #f8f9fa;
            cursor: pointer;
            font-size: 0.8rem;
            flex: 1;
        }
        
        .select-all-btn:hover {
            background-color: #e9ecef;
        }
        
        .clear-all-btn:hover {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .report-container {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            display: none;
            width: 100%;
            overflow-x: auto;
        }
        
        .report-container h3 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: white;
            border: 1px solid #ddd;
        }
        
        .report-table th {
            background-color: #ffd700;
            color: #333;
            padding: 12px 15px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        .report-table td {
            padding: 10px 15px;
            border: 1px solid #ddd;
            white-space: nowrap;
        }
        
        .report-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .report-table .total-row {
            background-color: #fff8dc;
            font-weight: bold;
        }
        
        .report-table .grand-total {
            background-color: #ffd700;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .district-report-section {
            margin-top: 30px;
        }
        
        .district-report-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .district-report-box {
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .district-report-box.franky {
            border-left: 5px solid #1976d2;
        }
        
        .district-report-box.kyrpad {
            border-left: 5px solid #7b1fa2;
        }
        
        .district-report-box.others-district {
            border-left: 5px solid #e65100;
        }
        
        .district-report-box h4 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .monthly-report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .monthly-report-table th {
            background-color: #f0f0f0;
            padding: 8px 10px;
            border: 1px solid #ddd;
        }
        
        .monthly-report-table td {
            padding: 6px 10px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            margin: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .export-preview {
            position: fixed;
            left: -9999px;
            top: 0;
            width: 1200px;
            background: white;
            padding: 30px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: -1;
        }
        
        .export-preview .report-table td {
            white-space: nowrap;
        }
        
        @media (max-width: 1200px) {
            .content {
                flex-direction: column;
            }
            
            .left-panel, .right-panel {
                width: 100%;
            }
            
            .left-panel {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
            
            button {
                min-width: 140px;
            }
        }
        
        @media (max-width: 768px) {
            .totals-container {
                grid-template-columns: 1fr;
            }
            
            button {
                min-width: 100%;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .filters-container {
                flex-direction: column;
            }
            
            .district-report-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-crown"></i> Auto Lube House Multi-Grade Analys</h1>
            <p class="subtitle">Track Gold, Silver, Bronze, Grease, Hydraulic, DEF, Green & Other Grades with District Classification (FRANKY, KYRPAD, OTHERS DISTRICT)</p>
        </header>
        
        <div class="content">
            <div class="panel left-panel">
                <h2><i class="fas fa-list"></i> SKU Codes by Grade <span class="sku-count" id="skuCount">32</span></h2>
                <p>SKU codes classified by grade type:</p>
                
                <div class="sku-list-container" id="skuListContainer">
                    <!-- SKU list will be populated by JavaScript -->
                </div>
                
                <div class="sku-info-container">
                    <h4><i class="fas fa-layer-group"></i> Grade Classification</h4>
                    <p>SKU codes are automatically classified into grades:</p>
                    <div style="padding-left: 20px;">
                        <span class="grade-indicator grade-gold"><i class="fas fa-crown"></i> Gold</span>
                        <span class="grade-indicator grade-silver"><i class="fas fa-medal"></i> Silver</span>
                        <span class="grade-indicator grade-bronze"><i class="fas fa-shield"></i> Bronze</span>
                        <span class="grade-indicator grade-grease"><i class="fas fa-oil-can"></i> Grease</span>
                        <span class="grade-indicator grade-hydraulic"><i class="fas fa-tint"></i> Hydraulic</span>
                        <span class="grade-indicator grade-def"><i class="fas fa-truck"></i> DEF</span>
                        <span class="grade-indicator grade-green"><i class="fas fa-leaf"></i> Green</span>
                        <span class="grade-indicator grade-other"><i class="fas fa-question-circle"></i> Other</span>
                    </div>
                    <div id="skuNameValidationInfo"></div>
                </div>
                
                <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-file-excel"></i>
                    <h3>Upload XLSX File</h3>
                    <p>Click to browse or drag and drop your Excel file</p>
                    <p><small>File should contain columns for SKU code, name, quantity, liters, district and month/date</small></p>
                    <input type="file" id="fileInput" accept=".xlsx, .xls">
                </div>
                
                <div class="mapping-section">
                    <h2><i class="fas fa-columns"></i> Map Your Columns</h2>
                    <p>Select which columns from your file correspond to each required field:</p>
                    
                    <div class="mapping-control">
                        <label for="skuCodeMap">SKU Code Column:</label>
                        <select id="skuCodeMap">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    
                    <div class="mapping-control">
                        <label for="skuNameMap">SKU Name Column:</label>
                        <select id="skuNameMap">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    
                    <div class="mapping-control">
                        <label for="qntyMap">Qnty Column:</label>
                        <select id="qntyMap">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    
                    <div class="mapping-control">
                        <label for="litersMap">Liters Column:</label>
                        <select id="litersMap">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    
                    <div class="mapping-control">
                        <label for="customerNameMap">Customer Name Column:</label>
                        <select id="customerNameMap">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    
                    <div class="mapping-control">
                        <label for="customerGroupMap">Customer Group Column:</label>
                        <select id="customerGroupMap">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    
                    <div class="mapping-control">
                        <label for="districtMap">Customer District Column:</label>
                        <select id="districtMap">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    
                    <div class="mapping-control">
                        <label for="monthMap">Month/Date Column:</label>
                        <select id="monthMap">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    
                    <div class="actions">
                        <button class="btn-primary" id="processBtn" onclick="processMapping()">
                            <i class="fas fa-cogs"></i> Process Mapping
                        </button>
                        <button class="btn-secondary" onclick="resetForm()">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 30px;">
                    <h2><i class="fas fa-chart-bar"></i> Generate Reports</h2>
                    <p>Generate comprehensive district and grade reports:</p>
                    
                    <div class="button-group">
                        <button class="btn-report" onclick="generateDistrictReport()">
                            <i class="fas fa-map"></i> District Report
                        </button>
                        <button class="btn-report" onclick="generateMonthlyReport()">
                            <i class="fas fa-calendar-alt"></i> Monthly Report
                        </button>
                        <button class="btn-report" onclick="generateGradeReport()">
                            <i class="fas fa-chart-pie"></i> Grade Analysis
                        </button>
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 30px;">
                    <h2><i class="fas fa-download"></i> Download Reports</h2>
                    <p>Download pre-defined sales and purchase reports:</p>
                    
                    <div class="button-group">
                        <button class="btn-sales" onclick="window.open('https://alh-5.github.io/site/data/sales2526.xlsx', '_blank')">
                            <i class="fas fa-chart-line"></i> Sales Report
                        </button>
                        <button class="btn-purchase" onclick="window.open('https://alh-5.github.io/site/data/purchase2526.xlsx', '_blank')">
                            <i class="fas fa-shopping-cart"></i> Purchase Report
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="panel right-panel">
                <h2><i class="fas fa-table"></i> Data Preview 
                    <span class="status-indicator status-pending" id="previewStatus">
                        <i class="fas fa-clock"></i> No file loaded
                    </span>
                </h2>
                
                <div class="filters-section" id="filtersSection" style="display: none;">
                    <h4><i class="fas fa-filter"></i> Filter Data (Multi-Select)</h4>
                    <div class="filters-container">
                        <div class="filter-group">
                            <label for="customerNameFilter"><i class="fas fa-user"></i> Customer Name:</label>
                            <div class="multi-select-container" id="customerNameFilterContainer">
                                <div class="multi-select-header" onclick="toggleMultiSelect('customerName')">
                                    <span>Select Customers <span class="selected-count" id="customerNameSelectedCount">0</span></span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multi-select-dropdown" id="customerNameFilterDropdown"></div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="customerGroupFilter"><i class="fas fa-users"></i> Customer Group:</label>
                            <div class="multi-select-container" id="customerGroupFilterContainer">
                                <div class="multi-select-header" onclick="toggleMultiSelect('customerGroup')">
                                    <span>Select Groups <span class="selected-count" id="customerGroupSelectedCount">0</span></span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multi-select-dropdown" id="customerGroupFilterDropdown"></div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="districtFilter"><i class="fas fa-map-marker-alt"></i> Customer District:</label>
                            <div class="multi-select-container" id="districtFilterContainer">
                                <div class="multi-select-header" onclick="toggleMultiSelect('district')">
                                    <span>Select Districts <span class="selected-count" id="districtSelectedCount">0</span></span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multi-select-dropdown" id="districtFilterDropdown"></div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="monthFilter"><i class="fas fa-calendar-alt"></i> Month (MMM YYYY):</label>
                            <div class="multi-select-container" id="monthFilterContainer">
                                <div class="multi-select-header" onclick="toggleMultiSelect('month')">
                                    <span>Select Months <span class="selected-count" id="monthSelectedCount">0</span></span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multi-select-dropdown" id="monthFilterDropdown"></div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="gradeFilter"><i class="fas fa-layer-group"></i> Grade:</label>
                            <div class="multi-select-container" id="gradeFilterContainer">
                                <div class="multi-select-header" onclick="toggleMultiSelect('grade')">
                                    <span>Select Grades <span class="selected-count" id="gradeSelectedCount">0</span></span>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="multi-select-dropdown" id="gradeFilterDropdown"></div>
                            </div>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="select-all-btn" onclick="handleSelectAll()">Select All Filters</button>
                        <button class="clear-all-btn" onclick="handleClearAll()">Clear All Filters</button>
                        <button class="reset-filters" onclick="resetFilters()">
                            <i class="fas fa-times"></i> Reset Filters
                        </button>
                    </div>
                </div>
                
                <div class="preview-table-container">
                    <table class="preview-table" id="previewTable">
                        <thead>
                            <tr>
                                <th>SKU Code</th>
                                <th>SKU Name</th>
                                <th>Qnty</th>
                                <th>Liters</th>
                                <th>Customer Name</th>
                                <th>Customer Group</th>
                                <th>District (Reclassified)</th>
                                <th>Month (MMM YYYY)</th>
                                <th>Grade</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                                    <i class="fas fa-file-excel" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                    Upload an Excel file to preview data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="sku-info-container" style="display: none;" id="districtClassificationInfo">
                    <h4><i class="fas fa-map-marked-alt"></i> District Classification Rules</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div style="padding: 10px; background-color: #e3f2fd; border-radius: 5px; border-left: 4px solid #1976d2;">
                            <strong>FRANKY District:</strong><br>
                            EAST KHASI HILLS<br>
                            WEST KHASI HILLS<br>
                            EASTNWEST KHASI HILLS<br>
                            RI BHOI<br>
                            SOUTHWEST KHASI HILS
                        </div>
                        <div style="padding: 10px; background-color: #f3e5f5; border-radius: 5px; border-left: 4px solid #7b1fa2;">
                            <strong>KYRPAD District:</strong><br>
                            WEST JAINTIA HILLS<br>
                            EAST JAINTIA HILLS<br>
                            JAINTIA HILLS
                        </div>
                        <div style="padding: 10px; background-color: #fff3e0; border-radius: 5px; border-left: 4px solid #e65100;">
                            <strong>OTHERS DISTRICT:</strong><br>
                            Any other district or blank
                        </div>
                    </div>
                </div>
                
                <div class="totals-container" id="totalsContainer" style="display: none;">
                    <!-- Grade Totals -->
                    <div class="total-box gold">
                        <div class="total-label"><i class="fas fa-crown"></i> Gold Grade Qnty</div>
                        <div class="total-value" id="totalGoldQnty">0</div>
                    </div>
                    <div class="total-box gold">
                        <div class="total-label"><i class="fas fa-crown"></i> Gold Grade Liters</div>
                        <div class="total-value" id="totalGoldLiters">0 <small>L</small></div>
                    </div>
                    <div class="total-box silver">
                        <div class="total-label"><i class="fas fa-medal"></i> Silver Grade Qnty</div>
                        <div class="total-value" id="totalSilverQnty">0</div>
                    </div>
                    <div class="total-box silver">
                        <div class="total-label"><i class="fas fa-medal"></i> Silver Grade Liters</div>
                        <div class="total-value" id="totalSilverLiters">0 <small>L</small></div>
                    </div>
                    <div class="total-box bronze">
                        <div class="total-label"><i class="fas fa-shield"></i> Bronze Grade Qnty</div>
                        <div class="total-value" id="totalBronzeQnty">0</div>
                    </div>
                    <div class="total-box bronze">
                        <div class="total-label"><i class="fas fa-shield"></i> Bronze Grade Liters</div>
                        <div class="total-value" id="totalBronzeLiters">0 <small>L</small></div>
                    </div>
                    <div class="total-box grease">
                        <div class="total-label"><i class="fas fa-oil-can"></i> Grease Grade Qnty</div>
                        <div class="total-value" id="totalGreaseQnty">0</div>
                    </div>
                    <div class="total-box grease">
                        <div class="total-label"><i class="fas fa-oil-can"></i> Grease Grade Liters</div>
                        <div class="total-value" id="totalGreaseLiters">0 <small>L</small></div>
                    </div>
                    <div class="total-box hydraulic">
                        <div class="total-label"><i class="fas fa-tint"></i> Hydraulic Grade Qnty</div>
                        <div class="total-value" id="totalHydraulicQnty">0</div>
                    </div>
                    <div class="total-box hydraulic">
                        <div class="total-label"><i class="fas fa-tint"></i> Hydraulic Grade Liters</div>
                        <div class="total-value" id="totalHydraulicLiters">0 <small>L</small></div>
                    </div>
                    <div class="total-box def">
                        <div class="total-label"><i class="fas fa-truck"></i> DEF Grade Qnty</div>
                        <div class="total-value" id="totalDefQnty">0</div>
                    </div>
                    <div class="total-box def">
                        <div class="total-label"><i class="fas fa-truck"></i> DEF Grade Liters</div>
                        <div class="total-value" id="totalDefLiters">0 <small>L</small></div>
                    </div>
                    <div class="total-box green">
                        <div class="total-label"><i class="fas fa-leaf"></i> Green Grade Qnty</div>
                        <div class="total-value" id="totalGreenQnty">0</div>
                    </div>
                    <div class="total-box green">
                        <div class="total-label"><i class="fas fa-leaf"></i> Green Grade Liters</div>
                        <div class="total-value" id="totalGreenLiters">0 <small>L</small></div>
                    </div>
                    <div class="total-box other">
                        <div class="total-label"><i class="fas fa-question-circle"></i> Other Grade Qnty</div>
                        <div class="total-value" id="totalOtherQnty">0</div>
                    </div>
                    <div class="total-box other">
                        <div class="total-label"><i class="fas fa-question-circle"></i> Other Grade Liters</div>
                        <div class="total-value" id="totalOtherLiters">0 <small>L</small></div>
                    </div>
                    <!-- District Totals -->
                    <div class="total-box franky">
                        <div class="total-label"><i class="fas fa-map-marker-alt"></i> FRANKY Qnty</div>
                        <div class="total-value" id="totalFrankyQnty">0</div>
                    </div>
                    <div class="total-box franky">
                        <div class="total-label"><i class="fas fa-map-marker-alt"></i> FRANKY Liters</div>
                        <div class="total-value" id="totalFrankyLiters">0 <small>L</small></div>
                    </div>
                    <div class="total-box kyrpad">
                        <div class="total-label"><i class="fas fa-map-marker-alt"></i> KYRPAD Qnty</div>
                        <div class="total-value" id="totalKyrpadQnty">0</div>
                    </div>
                    <div class="total-box kyrpad">
                        <div class="total-label"><i class="fas fa-map-marker-alt"></i> KYRPAD Liters</div>
                        <div class="total-value" id="totalKyrpadLiters">0 <small>L</small></div>
                    </div>
                    <div class="total-box others-district">
                        <div class="total-label"><i class="fas fa-map-marker-alt"></i> OTHERS DISTRICT Qnty</div>
                        <div class="total-value" id="totalOthersDistrictQnty">0</div>
                    </div>
                    <div class="total-box others-district">
                        <div class="total-label"><i class="fas fa-map-marker-alt"></i> OTHERS DISTRICT Liters</div>
                        <div class="total-value" id="totalOthersDistrictLiters">0 <small>L</small></div>
                    </div>
                </div>
                
                <div class="report-container" id="reportContainer">
                    <h3><i class="fas fa-chart-bar"></i> Generated Report</h3>
                    <div id="reportContent">
                        <!-- Report content will be inserted here -->
                    </div>
                    
                    <div class="button-group" style="margin-top: 20px; justify-content: flex-end;">
                        <button class="btn-text" onclick="exportReportToText()">
                            <i class="fas fa-file-alt"></i> Export Report to Text
                        </button>
                        <button class="btn-pdf" onclick="exportReportToPDF()">
                            <i class="fas fa-file-pdf"></i> Export as PDF
                        </button>
                        <button class="btn-report" onclick="exportReportAsPNG()">
                            <i class="fas fa-file-image"></i> Export as PNG
                        </button>
                        <button class="btn-export" onclick="exportReportToExcel()">
                            <i class="fas fa-file-excel"></i> Export to Excel
                        </button>
                    </div>
                </div>
                
                <div class="validation-result" id="validationResult" style="display: none;">
                    <h3><i class="fas fa-chart-pie"></i> Grade Analysis Results</h3>
                    <div id="validationContent"></div>
                </div>
                
                <div class="action-buttons">
                    <h2><i class="fas fa-download"></i> Export Data</h2>
                    <p>Export the mapped data with multi-grade analysis:</p>
                    
                    <div class="button-group">
                        <button class="btn-export" onclick="exportToExcel()">
                            <i class="fas fa-file-excel"></i> Export Raw Data to Excel
                        </button>
                        <button class="btn-pdf" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf"></i> Export Raw Data to PDF
                        </button>
                        <button class="btn-text" onclick="exportRawDataToText()">
                            <i class="fas fa-file-alt"></i> Export Raw Data to Text
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="exportPreviewContainer" class="export-preview"></div>
        
        <div id="reportModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Export Report as PNG</h3>
                    <button class="close-modal" onclick="closeReportModal()">&times;</button>
                </div>
                <div id="reportModalContent">
                    <p>Choose the report type to export as PNG:</p>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                        <button class="btn-primary" onclick="captureReportAsPNG('district')" style="width: 100%;">
                            <i class="fas fa-map"></i> District Report
                        </button>
                        <button class="btn-primary" onclick="captureReportAsPNG('monthly')" style="width: 100%;">
                            <i class="fas fa-calendar-alt"></i> Monthly Report
                        </button>
                        <button class="btn-primary" onclick="captureReportAsPNG('grade')" style="width: 100%;">
                            <i class="fas fa-chart-pie"></i> Grade Analysis Report
                        </button>
                        <button class="btn-primary" onclick="captureReportAsPNG('full')" style="width: 100%;">
                            <i class="fas fa-file-image"></i> Full Report Container
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Multi-Grade SKU Mapping Tool v7.6 | District Classification: FRANKY, KYRPAD, OTHERS DISTRICT |</p>
        </div>
    </div>

    <script>
        // ==================== GLOBAL VARIABLES ====================
        let currentMappedData = [];
        let filteredMappedData = [];
        
        // Grade totals - BRONZE ADDED
        let totalGoldQnty = 0, totalGoldLiters = 0;
        let totalSilverQnty = 0, totalSilverLiters = 0;
        let totalBronzeQnty = 0, totalBronzeLiters = 0;
        let totalGreaseQnty = 0, totalGreaseLiters = 0;
        let totalHydraulicQnty = 0, totalHydraulicLiters = 0;
        let totalDefQnty = 0, totalDefLiters = 0;
        let totalGreenQnty = 0, totalGreenLiters = 0;
        let totalOtherQnty = 0, totalOtherLiters = 0;
        
        // District totals
        let totalFrankyQnty = 0, totalFrankyLiters = 0;
        let totalKyrpadQnty = 0, totalKyrpadLiters = 0;
        let totalOthersDistrictQnty = 0, totalOthersDistrictLiters = 0;
        
        // Counters - BRONZE ADDED
        let goldSkuMatches = 0, silverSkuMatches = 0, bronzeSkuMatches = 0, greaseSkuMatches = 0, hydraulicSkuMatches = 0;
        let defSkuMatches = 0, greenSkuMatches = 0, otherSkuMatches = 0;
        let totalRows = 0, nameCorrections = 0;
        
        // Filter state
        let selectedCustomerNames = [];
        let selectedCustomerGroups = [];
        let selectedDistricts = [];
        let selectedMonths = [];
        let selectedGrades = [];
        let currentOpenDropdown = null;
        
        // Month names for conversion
        const monthNames = [
            'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
            'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
        ];
        
        // Multi-grade SKU codes with validated names
        const skuData = {
            '7434253': { validName: 'SERVO PRIDE NXT CK4 10W-30-15 L PROMO LUBE', grade: 'Gold' },
'7436250': { validName: 'SERVO PRIDE NXT CK4 15W-40-7.5 L PROMO', grade: 'Gold' },
'7434256': { validName: 'SERVO PRIDE NXT CK4 10W-30-15 L', grade: 'Gold' },
'7436256': { validName: 'SERVO PRIDE NXT CK4 15W-40-15 L', grade: 'Gold' },
'7436253': { validName: 'SERVO PRIDE NXT CK4 15W-40-15 L PROMO', grade: 'Gold' },
'7436184': { validName: 'SERVO PRIDE NXT CK4 15W-40-20 X 1 L', grade: 'Gold' },
'2967184': { validName: 'SERVO FUTURA G PLUS 5W-30-20 X 1 L', grade: 'Gold' },
'2967213': { validName: 'SERVO FUTURA G PLUS 5W-30-4 X 3.5 L', grade: 'Gold' },
'2967111': { validName: 'SERVO FUTURA G PLUS 5W-30-4X3.5 L PROMO', grade: 'Gold' },
'7271213': { validName: 'SERVO FUTURA NXT 0W-16-4 X 3.5 L', grade: 'Gold' },
'7271111': { validName: 'SERVO FUTURA NXT 0W-16-4X3.5 L PROMO LUBE', grade: 'Gold' },
'2914175': { validName: 'SERVO BRAKE FLUID DOT 4-20 X 1/2 L', grade: 'Gold' },
'2914165': { validName: 'SERVO BRAKE FLUID DOT 4-20 X 1/4 L', grade: 'Gold' },
'7429184': { validName: 'SERVO SUPERMILE 10W-30-20 X 1 L', grade: 'Gold' },
'7429240': { validName: 'SERVO SUPERMILE 10W-30-4 X 5 L PROMO', grade: 'Gold' },
'7429297': { validName: 'SERVO SUPERMILE 10W-30-7 L PROMO', grade: 'Gold' },
'7430240': { validName: 'SERVO SUPERMILE PLUS 5W-30-4 X 5 L PROMO', grade: 'Gold' },
'7430297': { validName: 'SERVO SUPERMILE PLUS 5W-30-7 L PROMO', grade: 'Gold' },
'2829230': { validName: 'SERVO 4T XTRA 10W-30-20 X 0.9 L PROMO', grade: 'Gold' },
'2828230': { validName: 'SERVO 4T XTRA-20 X 0.9 L PROMO', grade: 'Gold' },
'2828229': { validName: 'SERVO 4T XTRA-20 X 1 L PROMO', grade: 'Gold' },
'2971225': { validName: 'SERVO 4T HD-20 X 1.2 L', grade: 'Gold' },
'2971195': { validName: 'SERVO 4T HD-4 X 2.5 L', grade: 'Gold' },
'7584401': { validName: 'SERVO KOOL PLUS -210L BRL', grade: 'Gold' },
'7584185': { validName: 'SERVO KOOL PLUS-10X1L-HDPE', grade: 'Gold' },
'7584175': { validName: 'SERVO KOOL PLUS-20X1/2L-HDPE', grade: 'Gold' },
'7584184': { validName: 'SERVO KOOL PLUS-20X1L-HDPE', grade: 'Gold' },
'7607184': { validName: 'SERVO KOOL READY-20X1L-HDPE', grade: 'Gold' },
'2825185': { validName: 'SERVO HYPERSPORT F5-10 X 1 L', grade: 'Gold' },
'2825258': { validName: 'SERVO HYPERSPORT F5-10 X 1 L PROMO', grade: 'Gold' },
'7275111': { validName: 'SERVO BLACKBIRD X-4X3.5 L PROMO', grade: 'Gold' },
'2967204': { validName: 'SERVO FUTURA G PLUS 5W-30-4 X 3 L PROMO', grade: 'Gold' },
'2824184': { validName: 'SERVO 4T GREEN-20 X 1 L', grade: 'Green' },
'7211213': { validName: 'SERVO GREENMILE-4 X 3.5 L', grade: 'Green' },
'7330242': { validName: 'IOC CLEARBLUE-10 L', grade: 'DEF' },
'7330265': { validName: 'IOC CLEARBLUE-20 L', grade: 'DEF' },
'7701341': { validName: 'SERVO GREASE MP-20 KG BUC', grade: 'Grease' },
'7705303': { validName: 'SERVO GREASE MP 3 - 20 X 1/2 KG CTN', grade: 'Grease' },
'7705313': { validName: 'SERVO GREASE MP 3 - 10 X 1 KG CTN', grade: 'Grease' },
'7705327': { validName: 'SERVOGREASE MP 3-6X2 KG', grade: 'Grease' },
'7705337': { validName: 'SERVOGREASE MP 3-4X3 KG', grade: 'Grease' },
'7705339': { validName: 'SERVOGREASE MP 3 - 5 KG BUC', grade: 'Grease' },
'7705340': { validName: 'SERVOGREASE MP 3-2 X 5 KG', grade: 'Grease' },
'7705341': { validName: 'SERVOGREASE MP 3 -20 KG BUC', grade: 'Grease' },
'7727303': { validName: 'SERVO GEM RR 3 - 20 X 1/2 KG CTN', grade: 'Grease' },
'7727313': { validName: 'SERVO GEM RR 3 - 10 X 1 KG CTN', grade: 'Grease' },
'7727327': { validName: 'SERVO GEM RR 3-6X2 KG TUB', grade: 'Grease' },
'7727337': { validName: 'SERVO GEM RR 3-4X3 KG', grade: 'Grease' },
'7727341': { validName: 'SERVO GEM RR 3 - 20 KG. BUC', grade: 'Grease' },
'7849303': { validName: 'SERVO LONG LIFE GREASE-20 X 1/2 KG', grade: 'Grease' },
'7849313': { validName: 'SERVO LONG LIFE GREASE-10X1 KG TUB', grade: 'Grease' },
'7849327': { validName: 'SERVO LONG LIFE GREASE-6X2 KG TUB', grade: 'Grease' },
'7849337': { validName: 'SERVO LONG LIFE GREASE-4X3 KG TUB', grade: 'Grease' },
'7849340': { validName: 'SERVO LONG LIFE GREASE-2 X 5 KG', grade: 'Grease' },
'7849341': { validName: 'SERVO LONG LIFE GREASE-20 KG', grade: 'Grease' },
'7849343': { validName: 'SERVO LONG LIFE GREASE-7 KG', grade: 'Grease' },
'7849344': { validName: 'SERVO LONG LIFE GREASE-10 KG BUC', grade: 'Grease' },
'7903303': { validName: 'SERVOGREASE MIRACLE 3-20 X 1/2 KG', grade: 'Grease' },
'7903313': { validName: 'SERVOGREASE MIRACLE 3-10 X 1 KG', grade: 'Grease' },
'7903327': { validName: 'SERVOGREASE MIRACLE 3-6 X 2 KG', grade: 'Grease' },
'7903337': { validName: 'SERVOGREASE MIRACLE 3-4 X 3 KG', grade: 'Grease' },
'7903339': { validName: 'SERVOGREASE MIRACLE 3-5 KG ', grade: 'Grease' },
'7903343': { validName: 'SERVOGREASE MIRACLE 3-7 KG ', grade: 'Grease' },
'7903344': { validName: 'SERVOGREASE MIRACLE 3-10 KG BUC ', grade: 'Grease' },
'7903341': { validName: 'SERVOGREASE MIRACLE 3-20 KG', grade: 'Grease' },
'7742341': { validName: 'SERVOGEM EP 2-20 KG BUC', grade: 'Grease' },
'7903311': { validName: 'SERVOGREASE MIRACLE 3-1 KG GRES', grade: 'Grease' },
'7705451': { validName: 'SERVOGREASE MP 3 - 182 KG DRM', grade: 'Grease' },
'7742451': { validName: 'SERVOGEM EP 2-182 KG DRM', grade: 'Grease' },
'3040265': { validName: 'SERVOHYDRASHAKTI 68-20 L', grade: 'Hydraulic' },
'3006401': { validName: 'SERVOSYSTEM 68 - 210L BRL', grade: 'Hydraulic' },
'3006265': { validName: 'SERVOSYSTEM 68-20L BUC', grade: 'Hydraulic' },
'3006403': { validName: 'SERVOSYSTEM 68-210 L HD', grade: 'Hydraulic' },
'3006234': { validName: 'SERVOSYSTEM 68-4x5L - HDPE', grade: 'Hydraulic' },
'2502265': { validName: 'SERVO GEAR HP 90-20L BUC', grade: 'Silver' },
'7485174': { validName: 'SERVO SUPER 20W-40 MG-40X1/2L', grade: 'Silver' },
'7485242': { validName: 'SERVO SUPER 20W-40 MG-10 L', grade: 'Silver' },
'7485265': { validName: 'SERVO SUPER 20W-40 MG-20 L', grade: 'Silver' },
'7485234': { validName: 'SERVO SUPER 20W-40 MG-4x5L - HDPE', grade: 'Silver' },
'2931184': { validName: 'SERVO 4T 20W-50-20 X 1 L', grade: 'Silver' },
'2502184': { validName: 'SERVO GEAR HP 90-20X1L-HDPE', grade: 'Silver' },
'2900145': { validName: 'SERVO 2T SUPREME (JFC) - 200X60ML - POU', grade: 'Silver' },
'7577234': { validName: 'SERVO PREMIUM CF-4 15W-40-4X5L-HDPE', grade: 'Silver' },
'2889156': { validName: 'SERVO SCOOTOMATIC 4ST 10W-30-20 X 0.8 L', grade: 'Silver' },
'2900184': { validName: 'SERVO 2T SUPREME-20 X 1 L', grade: 'Silver' },
'2924229': { validName: 'SERVO 4T - 20 X 1 L HDPE PROMO', grade: 'Silver' },
'7577184': { validName: 'SERVO PREMIUM CF-4 15W-40-20X1L-HDPE', grade: 'Silver' },
'7489253': { validName: 'SERVO PRIDE XL PLUS 15W40-15L PROMO', grade: 'Silver' },
'7577265': { validName: 'SERVO PREMIUM CF 4 15W 40-20L BUC', grade: 'Silver' },
'4906234': { validName: 'SERVO TRANSFLUID A-4X5L-HDPE', grade: 'Silver' },
'7577401': { validName: 'SERVO PREMIUM CF-4 15W-40 - 210L BRL', grade: 'Silver' },
'7489241': { validName: 'SERVO PRIDE XL PLUS 15W40-10L PROMO', grade: 'Silver' },
'7489250': { validName: 'SERVO PRIDE XL PLUS 15W40-7.5L PROMO', grade: 'Silver' },
'7485184': { validName: 'SERVO SUPER 20W-40 MG-20 X 1 L', grade: 'Silver' },
'2502234': { validName: 'SERVO GEAR HP 90 - 4x5L - HDPE', grade: 'Silver' },
'2900125': { validName: 'SERVO 2T SUPREME(JFC)-300x40ML - POU', grade: 'Silver' },
'7511251': { validName: 'SERVO GEAR SUPER 80W-90-7.5 L', grade: 'Silver' },
'7577242': { validName: 'SERVO PREMIUM CF-4 15W-40-10L BUC', grade: 'Silver' },
'7556184': { validName: 'SERVO PRIDE TC 15W40 - 20X1L-HDPE', grade: 'Silver' },
'4906184': { validName: 'SERVO TRANSFLUID A-20X1L-HDPE', grade: 'Silver' },
'1404184': { validName: 'SERVO PRIDE 40 - 20x1L - HDPE', grade: 'Silver' },
'1404234': { validName: 'SERVO PRIDE 40 - 4x5L - HDPE', grade: 'Silver' },
'7577251': { validName: 'SERVO PREMIUM CF-4 15W-40-7.5 L', grade: 'Silver' },
'7511184': { validName: 'SERVO GEAR SUPER 80W-90 - 20 X 1 L HDPE', grade: 'Silver' },
'2896150': { validName: 'TRU4 KRAAFT-10 X 0.9 L', grade: 'Silver' },
'2896185': { validName: 'TRU4 KRAAFT-10 X 1 L', grade: 'Silver' },
'7515265': { validName: 'SERVO GEAR SUPER 85W-140-20 L BUC', grade: 'Silver' },
'7515401': { validName: 'SERVO GEAR SUPER 85W-140-210L BRL', grade: 'Silver' },
'2900175': { validName: 'SERVO 2T SUPREME-20X1/2 L', grade: 'Silver' },
'7485251': { validName: 'SERVO SUPER 20W-40 MG-7.5 L', grade: 'Silver' },
'7651265': { validName: 'SERVO AGROSPRAY T - 20 L BUC', grade: 'Silver' },
'7586265': { validName: 'SERVO ORCHARD SPRAY OIL - 20 L BUC', grade: 'Silver' },
'7511401': { validName: 'SERVO GEAR SUPER 80W-90 - 210L BRL', grade: 'Silver' },
'7577174': { validName: 'SERVO PREMIUM CF-4 15W-40-40X1/2L-HDPE', grade: 'Silver' },
'7556265': { validName: 'SERVO PRIDE TC 15W40 - 20L BUC', grade: 'Silver' },
'7577256': { validName: 'SERVO PREMIUM CF-4 15W-40-15 L', grade: 'Silver' },
'7489234': { validName: 'SERVO PRIDE XL PLUS 15W40-4x5L - HDPE', grade: 'Silver' },
'7515240': { validName: 'SERVO GEAR SUPER 85W-140-4 X 5 L PROMO', grade: 'Silver' },
'7556253': { validName: 'SERVO PRIDE TC 15W40-15L PROMO', grade: 'Silver' },
'7485401': { validName: 'SERVO SUPER 20W-40 MG-210 L BRL', grade: 'Silver' },
'1404265': { validName: 'SERVO PRIDE 40-20L BUC', grade: 'Silver' },
'7489265': { validName: 'SERVO PRIDE XL PLUS 15W40-20 L', grade: 'Silver' },
'7556250': { validName: 'SERVO PRIDE TC 15W40-7.5L PROMO', grade: 'Silver' },
'7489184': { validName: 'SERVO PRIDE XL PLUS 15W40-20 X 1 L', grade: 'Silver' },
'7556203': { validName: 'SERVO PRIDE TC 15W-40 - 4 X 3 L HDPE', grade: 'Silver' },
'2502401': { validName: 'SERVO GEAR HP 90 - 210L BRL', grade: 'Silver' },
'7556241': { validName: 'SERVO PRIDE TC 15W40-10L PROMO', grade: 'Silver' },
'4906175': { validName: 'SERVO TRANSFLUID A-20X1/2 L', grade: 'Silver' },
'7511265': { validName: 'SERVO GEAR SUPER 80W-90 - 20 L BUC', grade: 'Silver' },
'7515184': { validName: 'SERVO GEAR SUPER 85W-140 - 20 X 1 L HDPE', grade: 'Silver' },
'7511234': { validName: 'SERVO GEAR SUPER 80W-90 - 4 X 5 L HDPE', grade: 'Silver' },
'7511269': { validName: 'SERVO GEAR SUPER 80W-90-20 L PROMO', grade: 'Silver' },
'2900103': { validName: 'SERVO 2T SUPREME-600 X 20 ML', grade: 'Silver' },
'2889155': { validName: 'SERVO SCOOTOMTC 4ST 10W30-0.8 L', grade: 'Silver' },
'7515234': { validName: 'SERVO GEAR SUPER 85W-140 - 4 X 5 L HDPE', grade: 'Silver' },
'7511240': { validName: 'SERVO GEAR SUPER 80W-90-4 X 5 L PROMO', grade: 'Silver' },
'2924184': { validName: 'SERVO 4T-20X1L-HDPE', grade: 'Silver' },
'1404242': { validName: 'SERVO PRIDE 40 - 10L BUC', grade: 'Silver' },
'2502174': { validName: 'SERVO GEAR HP 90-40X1/2L-HDPE', grade: 'Silver' },
'2900174': { validName: 'SERVO 2T SUPREME-40X1/2L', grade: 'Silver' },
'3057265': { validName: 'SERVO EXCAVATOR TH 46 20 L', grade: 'Silver' },
'7489203': { validName: 'SERVO PRIDE XL PLUS 15W40-4X3 L', grade: 'Silver' },
'7577240': { validName: 'SERVO PREMIUM CF-4 15W-40-4x5L - PROMO', grade: 'Silver' },
'7485173': { validName: 'SERVO SUPER 20W-40 MG-1/2 L', grade: 'Silver' },
'7485183': { validName: 'SERVO SUPER 20W-40 MG-1 L', grade: 'Silver' },
'7556234': { validName: 'SERVO PRIDE TC 15W-40- 4 X 5L', grade: 'Silver' },
'4950234': { validName: 'SERVO OIB OIL-4x5L - HDPE', grade: 'Silver' },
'7586242': { validName: 'SERVO ORCHARD SPRAY OIL - 10 L BUC', grade: 'Silver' },
'7472256': { validName: 'SERVO FLT CF4 15W-40-15 L', grade: 'Bronze' },
'7427401': { validName: 'ECSTAR PETROL 0W-20-210 L', grade: 'Bronze' },
'2968213': { validName: 'HY.SERVO ENGINE OIL 5W-30-4x3.5L', grade: 'Bronze' },
'7477203': { validName: 'HY.SERVO PRM.EO SM 5W-30-4X3 L', grade: 'Bronze' },
'7600203': { validName: 'MGO 20W-40 - 4 X 3 L', grade: 'Bronze' },
'7688213': { validName: 'MGO 5W-30-4x3.5L HDPE', grade: 'Bronze' },
'7688203': { validName: 'MGO 5W-30-4 X 3 L', grade: 'Bronze' },
'7427213': { validName: 'ECSTAR PETROL 0W-20-4 X 3.5 L', grade: 'Bronze' },
'2557195': { validName: 'HYUNDAI S.GEAR OIL 75W-85-4X2.5L-HDPE', grade: 'Bronze' },
'7600184': { validName: 'MGO 20W-40 - 20 X 1 L', grade: 'Bronze' },
'2540199': { validName: 'MGGO 80W-90 - 4 X 2.1 L', grade: 'Bronze' },
'7420213': { validName: 'HY SERVO PETROL EO SN PLUS-4 X 3.5 L LUBE', grade: 'Bronze' },
'7205222': { validName: 'HYUNDAI SERVO SUPERIOR 0W30-4 X 4 L', grade: 'Bronze' },
'2933156': { validName: 'SERVO HONDA SCOOTONXT-20 X 0.8 L', grade: 'Bronze' },
'7638234': { validName: 'HYUNDAI SERVO CRDi PREM.ENG.OIL 4X5L-HDP', grade: 'Bronze' },
'7470401': { validName: 'S FLEET SUPREME CI4PLUS 15W-40-210 L LUBE', grade: 'Bronze' },
'7421234': { validName: 'HYUNDAI SERVO DEO ACEA C5-4 X 5 L LUBE', grade: 'Bronze' },
'7470256': { validName: 'SERVO FLEET SUPREME CI4 PLUS 15W-40-15 L LUBE', grade: 'Bronze' },
'7232184': { validName: 'HYUNDAI SERVO COOLANT 50-20 X 1 L', grade: 'Bronze' },
'2918175': { validName: 'HYUNDAI SERVO BRAKE OIL - 20x1/2L - HDPE', grade: 'Bronze' },
'3725213': { validName: 'SERVO SUPER PUMP SO 40-4x3.5L HDPE', grade: 'Bronze' },
'7472184': { validName: 'SERVO FLEET CF4 15W-40 - 20 X 1 L', grade: 'Bronze' },
'7472234': { validName: 'SERVO FLEET CF4 15W-40 - 4 X 5 L', grade: 'Bronze' },
'7472203': { validName: 'SERVO FLT CF4 15W-40-4 X 3 L', grade: 'Bronze' },
'7688401': { validName: 'MGO 5W-30-210 L BRL', grade: 'Bronze' },
'7670213': { validName: 'MGDO 15W-40 - 4 X 3.5 L', grade: 'Bronze' },
'7420222': { validName: 'HY SERVO PETROL EO SN PLUS-4 X 4 L LUBE', grade: 'Bronze' },
'7420401': { validName: 'HY SERVO PETROL EO SN PLUS-210 L', grade: 'Bronze' },
'2927152': { validName: 'SERVO HONDA JOSH-20 X 0.9 L', grade: 'Bronze' },
'7472401': { validName: 'SERVO FLT CF4 15W-40 - 210 L', grade: 'Bronze' },
'7427183': { validName: 'ECSTAR PETROL 0W-20-1 L', grade: 'Bronze' },
'2953213': { validName: 'HY.SERVO SYNTH PLUS 5W-30-4x3.5L HDPE', grade: 'Bronze' },
'7470184': { validName: 'S FLEET SUPREME CI4PLUS 15W-40-20 X 1 L LUBE', grade: 'Bronze' },
'2927184': { validName: 'SERVO HONDA JOSH-20 X 1 L', grade: 'Bronze' },
'7209213': { validName: 'HY SERVO SYNTH 0W-30 SP/C3-4 X 3.5 L', grade: 'Bronze' },
'7208271': { validName: 'SERVO SUPERIOR EO 0W20 SN PLUS-50 L', grade: 'Bronze' }
        };
        
        const allSkuCodes = Object.keys(skuData);
        
        // ==================== DISTRICT RECLASSIFICATION ====================
        function reclassifyDistrict(district) {
            if (!district) return 'OTHERS DISTRICT';
            const d = district.toString().toUpperCase().trim();
            
            const frankySet = new Set([
                'EAST KHASI HILLS',
                'WEST KHASI HILLS',
                'EASTNWEST KHASI HILLS',
                'RI BHOI',
                'SOUTHWEST KHASI HILS'
            ]);
            
            const kyrpadSet = new Set([
                'WEST JAINTIA HILLS',
                'EAST JAINTIA HILLS',
                'JAINTIA HILLS'
            ]);
            
            for (let pattern of frankySet) {
                if (d.includes(pattern)) return 'FRANKY';
            }
            for (let pattern of kyrpadSet) {
                if (d.includes(pattern)) return 'KYRPAD';
            }
            return 'OTHERS DISTRICT';
        }
        
        // ==================== INITIALIZATION ====================
        function initializeSkuList() {
            const skuListContainer = document.getElementById('skuListContainer');
            const skuCountElement = document.getElementById('skuCount');
            skuCountElement.textContent = allSkuCodes.length;
            skuListContainer.innerHTML = '';
            
            let goldCount = 0, silverCount = 0, bronzeCount = 0, greaseCount = 0, hydraulicCount = 0, defCount = 0, greenCount = 0, otherCount = 0;
            
            allSkuCodes.forEach(sku => {
                const info = skuData[sku];
                const div = document.createElement('div');
                div.className = `sku-item ${info.grade.toLowerCase()}`;
                
                if (info.grade === 'Gold') goldCount++;
                else if (info.grade === 'Silver') silverCount++;
                else if (info.grade === 'Bronze') bronzeCount++;
                else if (info.grade === 'Grease') greaseCount++;
                else if (info.grade === 'Hydraulic') hydraulicCount++;
                else if (info.grade === 'DEF') defCount++;
                else if (info.grade === 'Green') greenCount++;
                else otherCount++;
                
                let badge = '';
                switch(info.grade) {
                    case 'Gold': badge = '<span class="grade-indicator grade-gold"><i class="fas fa-crown"></i> Gold</span>'; break;
                    case 'Silver': badge = '<span class="grade-indicator grade-silver"><i class="fas fa-medal"></i> Silver</span>'; break;
                    case 'Bronze': badge = '<span class="grade-indicator grade-bronze"><i class="fas fa-shield"></i> Bronze</span>'; break;
                    case 'Grease': badge = '<span class="grade-indicator grade-grease"><i class="fas fa-oil-can"></i> Grease</span>'; break;
                    case 'Hydraulic': badge = '<span class="grade-indicator grade-hydraulic"><i class="fas fa-tint"></i> Hydraulic</span>'; break;
                    case 'DEF': badge = '<span class="grade-indicator grade-def"><i class="fas fa-truck"></i> DEF</span>'; break;
                    case 'Green': badge = '<span class="grade-indicator grade-green"><i class="fas fa-leaf"></i> Green</span>'; break;
                    default: badge = '<span class="grade-indicator grade-other">Other</span>';
                }
                
                div.innerHTML = `<div><strong>${sku}</strong><div class="sku-name">${info.validName}</div></div>${badge}`;
                skuListContainer.appendChild(div);
            });
            
            document.getElementById('skuNameValidationInfo').innerHTML = `
                <p><strong>Grade Distribution:</strong></p>
                <ul style="padding-left: 20px; margin-top: 8px;">
                    <li><span class="grade-indicator grade-gold"><i class="fas fa-crown"></i> Gold</span>: ${goldCount} SKUs</li>
                    <li><span class="grade-indicator grade-silver"><i class="fas fa-medal"></i> Silver</span>: ${silverCount} SKUs</li>
                    <li><span class="grade-indicator grade-bronze"><i class="fas fa-shield"></i> Bronze</span>: ${bronzeCount} SKUs</li>
                    <li><span class="grade-indicator grade-grease"><i class="fas fa-oil-can"></i> Grease</span>: ${greaseCount} SKUs</li>
                    <li><span class="grade-indicator grade-hydraulic"><i class="fas fa-tint"></i> Hydraulic</span>: ${hydraulicCount} SKUs</li>
                    <li><span class="grade-indicator grade-def"><i class="fas fa-truck"></i> DEF</span>: ${defCount} SKUs</li>
                    <li><span class="grade-indicator grade-green"><i class="fas fa-leaf"></i> Green</span>: ${greenCount} SKUs</li>
                    <li><span class="grade-indicator grade-other"><i class="fas fa-question-circle"></i> Other</span>: ${otherCount} SKUs</li>
                </ul>
            `;
        }
        
        // ==================== COMPLETELY REWRITTEN DATE CONVERSION - FIXED FOR 1ST DAY OF MONTH ====================
        
        function convertExcelDate(excelDate) {
            if (!excelDate || excelDate < 1) return null;
            
            try {
                // Excel date system: 
                // 1 = January 1, 1900
                // But Excel incorrectly treats 1900 as leap year
                
                // Convert Excel serial to days since 1899-12-31
                let days = Math.floor(excelDate);
                
                // Adjust for Excel's leap year bug (dates after Feb 28, 1900 need adjustment)
                if (days >= 60) {
                    days -= 1;
                }
                
                // Days since 1899-12-31 to milliseconds
                const milliseconds = days * 24 * 60 * 60 * 1000;
                
                // Create date in UTC to avoid timezone issues
                const date = new Date(Date.UTC(1899, 11, 31) + milliseconds);
                
                return date;
            } catch (e) {
                console.error('Error converting Excel date:', e);
                return null;
            }
        }
        
        function convertDateToMonth(dateValue) {
            if (dateValue === null || dateValue === undefined || dateValue === '') return '';
            
            try {
                let year, month;
                let date = null;
                
                // CASE 1: Excel serial number
                if (typeof dateValue === 'number' && dateValue >= 1 && dateValue <= 50000) {
                    date = convertExcelDate(dateValue);
                }
                // CASE 2: Already a Date object
                else if (dateValue instanceof Date) {
                    date = new Date(Date.UTC(
                        dateValue.getUTCFullYear(),
                        dateValue.getUTCMonth(),
                        dateValue.getUTCDate(),
                        12, 0, 0
                    ));
                }
                // CASE 3: String date
                else if (typeof dateValue === 'string') {
                    const str = dateValue.toString().trim();
                    
                    // Try DD/MM/YYYY format (common in Excel exports)
                    const dmyMatch = str.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
                    if (dmyMatch) {
                        let day = parseInt(dmyMatch[1], 10);
                        let monthIdx = parseInt(dmyMatch[2], 10) - 1; // 0-based month
                        let yr = parseInt(dmyMatch[3], 10);
                        
                        // Handle 2-digit years
                        if (yr < 100) {
                            yr = yr < 50 ? 2000 + yr : 1900 + yr;
                        }
                        
                        // Create UTC date
                        date = new Date(Date.UTC(yr, monthIdx, day, 12, 0, 0));
                    }
                    // Try MM/DD/YYYY format
                    else {
                        const parts = str.split(/[\/\-\.]/);
                        if (parts.length === 3) {
                            let monthIdx = parseInt(parts[0], 10) - 1;
                            let day = parseInt(parts[1], 10);
                            let yr = parseInt(parts[2], 10);
                            
                            if (yr < 100) {
                                yr = yr < 50 ? 2000 + yr : 1900 + yr;
                            }
                            
                            date = new Date(Date.UTC(yr, monthIdx, day, 12, 0, 0));
                        } else {
                            // Try standard JS date parsing
                            const jsDate = new Date(str);
                            if (!isNaN(jsDate.getTime())) {
                                date = new Date(Date.UTC(
                                    jsDate.getFullYear(),
                                    jsDate.getMonth(),
                                    jsDate.getDate(),
                                    12, 0, 0
                                ));
                            }
                        }
                    }
                }
                
                // If we got a valid date, extract UTC components
                if (date && !isNaN(date.getTime())) {
                    year = date.getUTCFullYear();
                    month = date.getUTCMonth();
                    
                    return `${monthNames[month]} ${year}`;
                }
                
                // If all parsing fails, return the original value
                return dateValue?.toString() || '';
                
            } catch (e) {
                console.error('Date parsing error:', e);
                return dateValue?.toString() || '';
            }
        }
        
        // ==================== FILE HANDLING ====================
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('previewStatus').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading file...';
            document.getElementById('previewStatus').className = 'status-indicator status-pending';
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, { header:1, raw:true, defval:null });
                    if (json.length===0) { alert('Empty file'); resetForm(); return; }
                    updateMappingDropdowns(json[0]);
                    displayDataPreview(json);
                    document.getElementById('previewStatus').innerHTML = '<i class="fas fa-check"></i> File loaded';
                    document.getElementById('previewStatus').className = 'status-indicator status-ready';
                } catch(err) { console.error(err); alert('Invalid file'); resetForm(); }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function updateMappingDropdowns(headers) {
            const ids = ['skuCodeMap','skuNameMap','qntyMap','litersMap','customerNameMap','customerGroupMap','districtMap','monthMap'];
            ids.forEach(id => {
                const sel = document.getElementById(id);
                while (sel.options.length>1) sel.remove(1);
                headers.forEach((h,i) => {
                    if (h?.toString().trim()) {
                        const opt = document.createElement('option');
                        opt.value = i; opt.text = `${h} (Col ${i+1})`;
                        sel.appendChild(opt);
                    }
                });
                // auto-detect
                const name = id.replace('Map','').toLowerCase();
                let found = -1;
                headers.forEach((h,i) => {
                    if (h) {
                        const low = h.toString().toLowerCase();
                        if (low.includes(name) ||
                            (name==='qnty' && (low.includes('quantity')||low.includes('qty'))) ||
                            (name==='liters' && (low.includes('liter')||low.includes('volume'))) ||
                            (name==='customername' && low.includes('customer') && low.includes('name')) ||
                            (name==='customergroup' && low.includes('customer') && low.includes('group')) ||
                            (name==='district' && (low.includes('district')||low.includes('region'))) ||
                            (name==='month' && (low.includes('month')||low.includes('date')))
                        ) found = i;
                    }
                });
                if (found!==-1) sel.value = found;
            });
        }
        
        function displayDataPreview(data) {
            const tbody = document.getElementById('previewTableBody');
            const thead = document.querySelector('#previewTable thead tr');
            const headers = data[0];
            thead.innerHTML = headers.map(h => `<th>${h||''}</th>`).join('');
            const extra = 9 - headers.length;
            if (extra>0) thead.innerHTML += Array(extra).fill('<th></th>').join('');
            
            tbody.innerHTML = '';
            for (let i=1; i<Math.min(data.length,11); i++) {
                const row = data[i];
                const tr = document.createElement('tr');
                for (let j=0; j<headers.length; j++) {
                    const td = document.createElement('td');
                    td.textContent = row[j]?.toString() || '';
                    tr.appendChild(td);
                }
                if (extra>0) for (let j=0; j<extra; j++) tr.appendChild(document.createElement('td'));
                tbody.appendChild(tr);
            }
        }
        
        // ==================== MAPPING PROCESSING ====================
        function processMapping() {
            const idx = {
                sku: document.getElementById('skuCodeMap').value,
                name: document.getElementById('skuNameMap').value,
                qnty: document.getElementById('qntyMap').value,
                liters: document.getElementById('litersMap').value,
                cust: document.getElementById('customerNameMap').value,
                group: document.getElementById('customerGroupMap').value,
                dist: document.getElementById('districtMap').value,
                month: document.getElementById('monthMap').value
            };
            if (Object.values(idx).some(v=>!v)) { alert('Please map all columns'); return; }
            const file = document.getElementById('fileInput').files[0];
            if (!file) { alert('Upload a file'); return; }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type:'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws, { header:1, raw:true, defval:null });
                    processMappedData(json, idx.sku, idx.name, idx.qnty, idx.liters, idx.cust, idx.group, idx.dist, idx.month);
                } catch(err) { console.error(err); alert('Processing error'); }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processMappedData(data, skuIdx, nameIdx, qtyIdx, litIdx, custIdx, grpIdx, distIdx, monIdx) {
            // Reset - BRONZE ADDED
            currentMappedData = [];
            totalGoldQnty=0; totalGoldLiters=0;
            totalSilverQnty=0; totalSilverLiters=0;
            totalBronzeQnty=0; totalBronzeLiters=0;
            totalGreaseQnty=0; totalGreaseLiters=0;
            totalHydraulicQnty=0; totalHydraulicLiters=0;
            totalDefQnty=0; totalDefLiters=0;
            totalGreenQnty=0; totalGreenLiters=0;
            totalOtherQnty=0; totalOtherLiters=0;
            totalFrankyQnty=0; totalFrankyLiters=0;
            totalKyrpadQnty=0; totalKyrpadLiters=0;
            totalOthersDistrictQnty=0; totalOthersDistrictLiters=0;
            goldSkuMatches=0; silverSkuMatches=0; bronzeSkuMatches=0; greaseSkuMatches=0; hydraulicSkuMatches=0;
            defSkuMatches=0; greenSkuMatches=0; otherSkuMatches=0;
            totalRows=0; nameCorrections=0;
            
            const uniqueNames = new Set(), uniqueGroups = new Set(), uniqueDistricts = new Set(), uniqueMonths = new Set();
            const uniqueGrades = new Set(['Gold','Silver','Bronze','Grease','Hydraulic','DEF','Green','Other']);
            
            for (let i=1; i<data.length; i++) {
                const row = data[i];
                if (!row || row.length===0) continue;
                totalRows++;
                
                const skuCode = row[skuIdx]?.toString().trim() || '';
                const origName = row[nameIdx]?.toString().trim() || '';
                const qty = parseFloat(row[qtyIdx]) || 0;
                const lit = parseFloat(row[litIdx]) || 0;
                const custName = row[custIdx]?.toString().trim() || '';
                const custGroup = row[grpIdx]?.toString().trim() || '';
                const origDistrict = row[distIdx]?.toString().trim() || '';
                const monthOrig = row[monIdx];
                const monthDisp = convertDateToMonth(monthOrig);
                const reclassDistrict = reclassifyDistrict(origDistrict);
                
                if (custName) uniqueNames.add(custName);
                if (custGroup) uniqueGroups.add(custGroup);
                uniqueDistricts.add(reclassDistrict);
                if (monthDisp) uniqueMonths.add(monthDisp);
                
                const isKnown = allSkuCodes.includes(skuCode);
                const skuInfo = skuData[skuCode] || {};
                let grade = skuInfo.grade || 'Other';
                uniqueGrades.add(grade);
                
                let skuName = origName;
                let nameValidated = false;
                if (isKnown && skuInfo.validName && origName.toUpperCase() !== skuInfo.validName.toUpperCase()) {
                    skuName = skuInfo.validName;
                    nameValidated = true;
                    nameCorrections++;
                }
                
                // grade totals - BRONZE ADDED
                switch(grade) {
                    case 'Gold': goldSkuMatches++; totalGoldQnty+=qty; totalGoldLiters+=lit; break;
                    case 'Silver': silverSkuMatches++; totalSilverQnty+=qty; totalSilverLiters+=lit; break;
                    case 'Bronze': bronzeSkuMatches++; totalBronzeQnty+=qty; totalBronzeLiters+=lit; break;
                    case 'Grease': greaseSkuMatches++; totalGreaseQnty+=qty; totalGreaseLiters+=lit; break;
                    case 'Hydraulic': hydraulicSkuMatches++; totalHydraulicQnty+=qty; totalHydraulicLiters+=lit; break;
                    case 'DEF': defSkuMatches++; totalDefQnty+=qty; totalDefLiters+=lit; break;
                    case 'Green': greenSkuMatches++; totalGreenQnty+=qty; totalGreenLiters+=lit; break;
                    default: otherSkuMatches++; totalOtherQnty+=qty; totalOtherLiters+=lit; break;
                }
                
                // district totals
                switch(reclassDistrict) {
                    case 'FRANKY': totalFrankyQnty+=qty; totalFrankyLiters+=lit; break;
                    case 'KYRPAD': totalKyrpadQnty+=qty; totalKyrpadLiters+=lit; break;
                    default: totalOthersDistrictQnty+=qty; totalOthersDistrictLiters+=lit; break;
                }
                
                currentMappedData.push({
                    skuCode, originalSkuName: origName, skuName, qnty:qty, liters:lit,
                    customerName: custName, customerGroup: custGroup,
                    customerDistrictOriginal: origDistrict, customerDistrict: reclassDistrict,
                    monthOriginal: monthOrig, monthDisplay: monthDisp,
                    grade, isKnownSku: isKnown, nameValidated
                });
            }
            
            // update filter dropdowns
            updateFilterDropdowns(uniqueNames, uniqueGroups, uniqueDistricts, uniqueMonths, uniqueGrades);
            selectedCustomerNames = []; selectedCustomerGroups = []; selectedDistricts = []; selectedMonths = []; selectedGrades = [];
            filteredMappedData = [...currentMappedData];
            
            updatePreviewWithMappedData();
            updateTotalsDisplay();
            showValidationResults();
            
            document.getElementById('filtersSection').style.display = 'block';
            document.getElementById('districtClassificationInfo').style.display = 'block';
            document.getElementById('reportContainer').style.display = 'none';
        }
        
        // ==================== FILTERS ====================
        function updateFilterDropdowns(names, groups, districts, months, grades) {
            const containers = {
                customerName: document.getElementById('customerNameFilterDropdown'),
                customerGroup: document.getElementById('customerGroupFilterDropdown'),
                district: document.getElementById('districtFilterDropdown'),
                month: document.getElementById('monthFilterDropdown'),
                grade: document.getElementById('gradeFilterDropdown')
            };
            Object.values(containers).forEach(c=>c.innerHTML='');
            
            Array.from(names).sort().forEach(v=> {
                if (v.trim()) containers.customerName.innerHTML += `<div class="multi-select-option"><input type="checkbox" id="customerName_${v}" value="${v}" onchange="updateFilterSelection('customerName','${v.replace(/'/g,"\\'")}')"><label for="customerName_${v}">${v}</label></div>`;
            });
            Array.from(groups).sort().forEach(v=> {
                if (v.trim()) containers.customerGroup.innerHTML += `<div class="multi-select-option"><input type="checkbox" id="customerGroup_${v}" value="${v}" onchange="updateFilterSelection('customerGroup','${v.replace(/'/g,"\\'")}')"><label for="customerGroup_${v}">${v}</label></div>`;
            });
            Array.from(districts).sort().forEach(v=> {
                if (v.trim()) containers.district.innerHTML += `<div class="multi-select-option"><input type="checkbox" id="district_${v}" value="${v}" onchange="updateFilterSelection('district','${v.replace(/'/g,"\\'")}')"><label for="district_${v}">${v}</label></div>`;
            });
            Array.from(months).sort((a,b)=> {
                const val = m => { let p=m.split(' '); if(p.length==2){let idx=monthNames.indexOf(p[0]); if(idx!==-1) return parseInt(p[1])*12+idx;} return 0; };
                return val(a)-val(b);
            }).forEach(v=> {
                if (v.trim()) containers.month.innerHTML += `<div class="multi-select-option"><input type="checkbox" id="month_${v}" value="${v}" onchange="updateFilterSelection('month','${v.replace(/'/g,"\\'")}')"><label for="month_${v}">${v}</label></div>`;
            });
            Array.from(grades).sort().forEach(v=> {
                if (v.trim()) containers.grade.innerHTML += `<div class="multi-select-option"><input type="checkbox" id="grade_${v}" value="${v}" onchange="updateFilterSelection('grade','${v.replace(/'/g,"\\'")}')"><label for="grade_${v}">${v}</label></div>`;
            });
            updateSelectedCounts();
        }
        
        function toggleMultiSelect(type) {
            document.querySelectorAll('.multi-select-dropdown').forEach(d=>d.classList.remove('show'));
            const dd = document.getElementById(`${type}FilterDropdown`);
            if (currentOpenDropdown === type) { currentOpenDropdown = null; dd.classList.remove('show'); }
            else { currentOpenDropdown = type; dd.classList.add('show'); }
        }
        
        function updateFilterSelection(type, value) {
            const safe = value.replace(/\\'/g,"'");
            const cb = document.getElementById(`${type}_${safe}`);
            if (!cb) return;
            if (type==='customerName') {
                if (cb.checked) selectedCustomerNames.push(safe); else selectedCustomerNames = selectedCustomerNames.filter(v=>v!==safe);
            } else if (type==='customerGroup') {
                if (cb.checked) selectedCustomerGroups.push(safe); else selectedCustomerGroups = selectedCustomerGroups.filter(v=>v!==safe);
            } else if (type==='district') {
                if (cb.checked) selectedDistricts.push(safe); else selectedDistricts = selectedDistricts.filter(v=>v!==safe);
            } else if (type==='month') {
                if (cb.checked) selectedMonths.push(safe); else selectedMonths = selectedMonths.filter(v=>v!==safe);
            } else if (type==='grade') {
                if (cb.checked) selectedGrades.push(safe); else selectedGrades = selectedGrades.filter(v=>v!==safe);
            }
            updateSelectedCounts();
            applyFilters();
            if (currentOpenDropdown) document.getElementById(`${currentOpenDropdown}FilterDropdown`)?.classList.add('show');
        }
        
        function updateSelectedCounts() {
            document.getElementById('customerNameSelectedCount').textContent = selectedCustomerNames.length;
            document.getElementById('customerGroupSelectedCount').textContent = selectedCustomerGroups.length;
            document.getElementById('districtSelectedCount').textContent = selectedDistricts.length;
            document.getElementById('monthSelectedCount').textContent = selectedMonths.length;
            document.getElementById('gradeSelectedCount').textContent = selectedGrades.length;
        }
        
        function selectAll(type) {
            const cbs = document.querySelectorAll(`#${type}FilterDropdown input[type="checkbox"]`);
            cbs.forEach(cb=>cb.checked=true);
            if (type==='customerName') selectedCustomerNames = Array.from(cbs).map(cb=>cb.value);
            else if (type==='customerGroup') selectedCustomerGroups = Array.from(cbs).map(cb=>cb.value);
            else if (type==='district') selectedDistricts = Array.from(cbs).map(cb=>cb.value);
            else if (type==='month') selectedMonths = Array.from(cbs).map(cb=>cb.value);
            else if (type==='grade') selectedGrades = Array.from(cbs).map(cb=>cb.value);
            updateSelectedCounts(); applyFilters();
        }
        
        function clearAll(type) {
            const cbs = document.querySelectorAll(`#${type}FilterDropdown input[type="checkbox"]`);
            cbs.forEach(cb=>cb.checked=false);
            if (type==='customerName') selectedCustomerNames = [];
            else if (type==='customerGroup') selectedCustomerGroups = [];
            else if (type==='district') selectedDistricts = [];
            else if (type==='month') selectedMonths = [];
            else if (type==='grade') selectedGrades = [];
            updateSelectedCounts(); applyFilters();
        }
        
        function handleSelectAll() {
            ['customerName','customerGroup','district','month','grade'].forEach(t=> {
                if (document.getElementById(`${t}FilterDropdown`).children.length) selectAll(t);
            });
        }
        function handleClearAll() {
            ['customerName','customerGroup','district','month','grade'].forEach(t=> {
                if (document.getElementById(`${t}FilterDropdown`).children.length) clearAll(t);
            });
        }
        
        function applyFilters() {
            filteredMappedData = currentMappedData.filter(it =>
                (selectedCustomerNames.length===0 || selectedCustomerNames.includes(it.customerName)) &&
                (selectedCustomerGroups.length===0 || selectedCustomerGroups.includes(it.customerGroup)) &&
                (selectedDistricts.length===0 || selectedDistricts.includes(it.customerDistrict)) &&
                (selectedMonths.length===0 || selectedMonths.includes(it.monthDisplay)) &&
                (selectedGrades.length===0 || selectedGrades.includes(it.grade))
            );
            updatePreviewWithMappedData();
            updateFilteredTotals();
        }
        
        function resetFilters() {
            clearAll('customerName'); clearAll('customerGroup'); clearAll('district'); clearAll('month'); clearAll('grade');
            filteredMappedData = [...currentMappedData];
            updatePreviewWithMappedData();
            updateFilteredTotals();
            document.querySelectorAll('.multi-select-dropdown').forEach(d=>d.classList.remove('show'));
            currentOpenDropdown = null;
        }
        
        // ==================== UI UPDATES ====================
        function updatePreviewWithMappedData() {
            const tbody = document.getElementById('previewTableBody');
            const thead = document.querySelector('#previewTable thead tr');
            thead.innerHTML = '<th>SKU Code</th><th>SKU Name</th><th>Qnty</th><th>Liters</th><th>Customer Name</th><th>Customer Group</th><th>District (Reclassified)</th><th>Month (MMM YYYY)</th><th>Grade</th>';
            tbody.innerHTML = '';
            
            const max = Math.min(filteredMappedData.length, 15);
            for (let i=0; i<max; i++) {
                const it = filteredMappedData[i];
                const tr = document.createElement('tr');
                tr.className = `${it.grade.toLowerCase()}-row`;
                
                let distBadge = '';
                if (it.customerDistrict==='FRANKY') distBadge = '<span class="district-indicator district-franky"><i class="fas fa-map-marker-alt"></i> FRANKY</span>';
                else if (it.customerDistrict==='KYRPAD') distBadge = '<span class="district-indicator district-kyrpad"><i class="fas fa-map-marker-alt"></i> KYRPAD</span>';
                else distBadge = '<span class="district-indicator district-others"><i class="fas fa-map-marker-alt"></i> OTHERS DISTRICT</span>';
                
                let gradeBadge = '';
                switch(it.grade) {
                    case 'Gold': gradeBadge = '<span class="grade-indicator grade-gold"><i class="fas fa-crown"></i> Gold</span>'; break;
                    case 'Silver': gradeBadge = '<span class="grade-indicator grade-silver"><i class="fas fa-medal"></i> Silver</span>'; break;
                    case 'Bronze': gradeBadge = '<span class="grade-indicator grade-bronze"><i class="fas fa-shield"></i> Bronze</span>'; break;
                    case 'Grease': gradeBadge = '<span class="grade-indicator grade-grease"><i class="fas fa-oil-can"></i> Grease</span>'; break;
                    case 'Hydraulic': gradeBadge = '<span class="grade-indicator grade-hydraulic"><i class="fas fa-tint"></i> Hydraulic</span>'; break;
                    case 'DEF': gradeBadge = '<span class="grade-indicator grade-def"><i class="fas fa-truck"></i> DEF</span>'; break;
                    case 'Green': gradeBadge = '<span class="grade-indicator grade-green"><i class="fas fa-leaf"></i> Green</span>'; break;
                    default: gradeBadge = '<span class="grade-indicator grade-other"><i class="fas fa-question-circle"></i> Other</span>';
                }
                
                tr.innerHTML = `
                    <td>${it.skuCode}</td>
                    <td>${it.skuName}${it.nameValidated?' <span style="color:#4CAF50;"><i class="fas fa-check"></i></span>':''}</td>
                    <td>${formatNumber(it.qnty)}</td>
                    <td>${formatNumber(it.liters)}</td>
                    <td>${it.customerName}</td>
                    <td>${it.customerGroup}</td>
                    <td>${distBadge}</td>
                    <td>${it.monthDisplay}</td>
                    <td>${gradeBadge}</td>
                `;
                tbody.appendChild(tr);
            }
            if (filteredMappedData.length===0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#999;"><i class="fas fa-filter" style="font-size:2rem;"></i><br>No data matches filters</td></tr>';
            } else if (filteredMappedData.length>15) {
                tbody.innerHTML += `<tr><td colspan="9" style="text-align:center;padding:15px;color:#666;">Showing 15 of ${filteredMappedData.length} rows (filtered)</td></tr>`;
            }
        }
        
        function updateTotalsDisplay() {
            document.getElementById('totalGoldQnty').textContent = formatNumber(totalGoldQnty);
            document.getElementById('totalGoldLiters').textContent = `${formatNumber(totalGoldLiters)}`;
            document.getElementById('totalSilverQnty').textContent = formatNumber(totalSilverQnty);
            document.getElementById('totalSilverLiters').textContent = `${formatNumber(totalSilverLiters)}`;
            document.getElementById('totalBronzeQnty').textContent = formatNumber(totalBronzeQnty);
            document.getElementById('totalBronzeLiters').textContent = `${formatNumber(totalBronzeLiters)}`;
            document.getElementById('totalGreaseQnty').textContent = formatNumber(totalGreaseQnty);
            document.getElementById('totalGreaseLiters').textContent = `${formatNumber(totalGreaseLiters)}`;
            document.getElementById('totalHydraulicQnty').textContent = formatNumber(totalHydraulicQnty);
            document.getElementById('totalHydraulicLiters').textContent = `${formatNumber(totalHydraulicLiters)}`;
            document.getElementById('totalDefQnty').textContent = formatNumber(totalDefQnty);
            document.getElementById('totalDefLiters').textContent = `${formatNumber(totalDefLiters)}`;
            document.getElementById('totalGreenQnty').textContent = formatNumber(totalGreenQnty);
            document.getElementById('totalGreenLiters').textContent = `${formatNumber(totalGreenLiters)}`;
            document.getElementById('totalOtherQnty').textContent = formatNumber(totalOtherQnty);
            document.getElementById('totalOtherLiters').textContent = `${formatNumber(totalOtherLiters)}`;
            
            document.getElementById('totalFrankyQnty').textContent = formatNumber(totalFrankyQnty);
            document.getElementById('totalFrankyLiters').textContent = `${formatNumber(totalFrankyLiters)}`;
            document.getElementById('totalKyrpadQnty').textContent = formatNumber(totalKyrpadQnty);
            document.getElementById('totalKyrpadLiters').textContent = `${formatNumber(totalKyrpadLiters)}`;
            document.getElementById('totalOthersDistrictQnty').textContent = formatNumber(totalOthersDistrictQnty);
            document.getElementById('totalOthersDistrictLiters').textContent = `${formatNumber(totalOthersDistrictLiters)}`;
            
            document.getElementById('totalsContainer').style.display = 'grid';
        }
        
        function updateFilteredTotals() {
            let fGoldQ=0,fGoldL=0, fSilverQ=0,fSilverL=0, fBronzeQ=0,fBronzeL=0, fGreaseQ=0,fGreaseL=0, fHydQ=0,fHydL=0, fDefQ=0,fDefL=0, fGreenQ=0,fGreenL=0, fOtherQ=0,fOtherL=0;
            let fFrankyQ=0,fFrankyL=0, fKyrpadQ=0,fKyrpadL=0, fOthersQ=0,fOthersL=0;
            
            filteredMappedData.forEach(it => {
                switch(it.grade) {
                    case 'Gold': fGoldQ+=it.qnty; fGoldL+=it.liters; break;
                    case 'Silver': fSilverQ+=it.qnty; fSilverL+=it.liters; break;
                    case 'Bronze': fBronzeQ+=it.qnty; fBronzeL+=it.liters; break;
                    case 'Grease': fGreaseQ+=it.qnty; fGreaseL+=it.liters; break;
                    case 'Hydraulic': fHydQ+=it.qnty; fHydL+=it.liters; break;
                    case 'DEF': fDefQ+=it.qnty; fDefL+=it.liters; break;
                    case 'Green': fGreenQ+=it.qnty; fGreenL+=it.liters; break;
                    default: fOtherQ+=it.qnty; fOtherL+=it.liters;
                }
                switch(it.customerDistrict) {
                    case 'FRANKY': fFrankyQ+=it.qnty; fFrankyL+=it.liters; break;
                    case 'KYRPAD': fKyrpadQ+=it.qnty; fKyrpadL+=it.liters; break;
                    default: fOthersQ+=it.qnty; fOthersL+=it.liters;
                }
            });
            
            document.getElementById('totalGoldQnty').textContent = formatNumber(fGoldQ);
            document.getElementById('totalGoldLiters').textContent = `${formatNumber(fGoldL)}`;
            document.getElementById('totalSilverQnty').textContent = formatNumber(fSilverQ);
            document.getElementById('totalSilverLiters').textContent = `${formatNumber(fSilverL)}`;
            document.getElementById('totalBronzeQnty').textContent = formatNumber(fBronzeQ);
            document.getElementById('totalBronzeLiters').textContent = `${formatNumber(fBronzeL)}`;
            document.getElementById('totalGreaseQnty').textContent = formatNumber(fGreaseQ);
            document.getElementById('totalGreaseLiters').textContent = `${formatNumber(fGreaseL)}`;
            document.getElementById('totalHydraulicQnty').textContent = formatNumber(fHydQ);
            document.getElementById('totalHydraulicLiters').textContent = `${formatNumber(fHydL)}`;
            document.getElementById('totalDefQnty').textContent = formatNumber(fDefQ);
            document.getElementById('totalDefLiters').textContent = `${formatNumber(fDefL)}`;
            document.getElementById('totalGreenQnty').textContent = formatNumber(fGreenQ);
            document.getElementById('totalGreenLiters').textContent = `${formatNumber(fGreenL)}`;
            document.getElementById('totalOtherQnty').textContent = formatNumber(fOtherQ);
            document.getElementById('totalOtherLiters').textContent = `${formatNumber(fOtherL)}`;
            
            document.getElementById('totalFrankyQnty').textContent = formatNumber(fFrankyQ);
            document.getElementById('totalFrankyLiters').textContent = `${formatNumber(fFrankyL)}`;
            document.getElementById('totalKyrpadQnty').textContent = formatNumber(fKyrpadQ);
            document.getElementById('totalKyrpadLiters').textContent = `${formatNumber(fKyrpadL)}`;
            document.getElementById('totalOthersDistrictQnty').textContent = formatNumber(fOthersQ);
            document.getElementById('totalOthersDistrictLiters').textContent = `${formatNumber(fOthersL)}`;
        }
        
        function showValidationResults() {
            const unknown = currentMappedData.filter(it=>!it.isKnownSku && it.skuCode).length;
            const totalVol = totalGoldLiters+totalSilverLiters+totalBronzeLiters+totalGreaseLiters+totalHydraulicLiters+totalDefLiters+totalGreenLiters+totalOtherLiters;
            document.getElementById('validationContent').innerHTML = `
                <div class="validation-item"><i class="fas fa-check-circle"></i><span><strong>${totalRows}</strong> rows</span></div>
                <div class="validation-item"><i class="fas fa-crown"></i><span><strong>${goldSkuMatches}</strong> Gold</span></div>
                <div class="validation-item"><i class="fas fa-medal"></i><span><strong>${silverSkuMatches}</strong> Silver</span></div>
                <div class="validation-item"><i class="fas fa-shield"></i><span><strong>${bronzeSkuMatches}</strong> Bronze</span></div>
                <div class="validation-item"><i class="fas fa-oil-can"></i><span><strong>${greaseSkuMatches}</strong> Grease</span></div>
                <div class="validation-item"><i class="fas fa-tint"></i><span><strong>${hydraulicSkuMatches}</strong> Hydraulic</span></div>
                <div class="validation-item"><i class="fas fa-truck"></i><span><strong>${defSkuMatches}</strong> DEF</span></div>
                <div class="validation-item"><i class="fas fa-leaf"></i><span><strong>${greenSkuMatches}</strong> Green</span></div>
                <div class="validation-item"><i class="fas fa-question-circle"></i><span><strong>${otherSkuMatches}</strong> Other</span></div>
                <div class="validation-item"><i class="fas fa-map-marker-alt"></i><span><strong>FRANKY:</strong> ${formatNumber(totalFrankyQnty)} Q, ${formatNumber(totalFrankyLiters)} L</span></div>
                <div class="validation-item"><i class="fas fa-map-marker-alt"></i><span><strong>KYRPAD:</strong> ${formatNumber(totalKyrpadQnty)} Q, ${formatNumber(totalKyrpadLiters)} L</span></div>
                <div class="validation-item"><i class="fas fa-map-marker-alt"></i><span><strong>OTHERS:</strong> ${formatNumber(totalOthersDistrictQnty)} Q, ${formatNumber(totalOthersDistrictLiters)} L</span></div>
                ${nameCorrections?`<div class="validation-item warning"><i class="fas fa-exclamation-triangle"></i><span><strong>${nameCorrections}</strong> names corrected</span></div>`:''}
                <div class="validation-item ${unknown?'error':''}"><i class="fas ${unknown?'fa-exclamation-triangle':'fa-check-circle'}"></i><span><strong>${unknown}</strong> unknown SKUs</span></div>
            `;
            document.getElementById('validationResult').style.display = 'block';
        }
        
        // ==================== REPORT GENERATORS ====================
        function generateDistrictReport() {
            if (!filteredMappedData.length) { alert('No data'); return; }
            const distData = {};
            filteredMappedData.forEach(it => {
                const d = it.customerDistrict, g = it.grade;
                if (!distData[d]) distData[d] = { Gold:0, Silver:0, Bronze:0, Grease:0, Hydraulic:0, DEF:0, Green:0, Other:0, totalQ:0, totalL:0 };
                distData[d][g] += it.liters;
                distData[d].totalQ += it.qnty;
                distData[d].totalL += it.liters;
            });
            let html = `<h4>District-Wise Grade Analysis (Liters)</h4><p>${new Date().toLocaleString()}</p><p>Filter: ${getFilterInfo()}</p>`;
            html += `<table class="report-table"><thead><tr><th>District</th><th>Gold</th><th>Silver</th><th>Bronze</th><th>Grease</th><th>Hydraulic</th><th>DEF</th><th>Green</th><th>Other</th><th>Total L</th></tr></thead><tbody>`;
            let grandQ=0,grandL=0;
            Object.keys(distData).sort().forEach(d => {
                const dd = distData[d];
                html += `<tr><td>${d}</td><td>${formatNumber(dd.Gold)}</td><td>${formatNumber(dd.Silver)}</td><td>${formatNumber(dd.Bronze)}</td><td>${formatNumber(dd.Grease)}</td><td>${formatNumber(dd.Hydraulic)}</td><td>${formatNumber(dd.DEF)}</td><td>${formatNumber(dd.Green)}</td><td>${formatNumber(dd.Other)}</td><td><strong>${formatNumber(dd.totalL)}</strong></td></tr>`;
                grandQ += dd.totalQ; grandL += dd.totalL;
            });
            html += `<tr class="grand-total"><td><strong>GRAND TOTAL</strong></td><td colspan="8"></td><td><strong>${formatNumber(grandL)} L</strong></td></tr>`;
            html += `</tbody></table>`;
            document.getElementById('reportContent').innerHTML = html;
            document.getElementById('reportContainer').style.display = 'block';
        }
        
        function generateMonthlyReport() {
            if (!filteredMappedData.length) { alert('No data'); return; }
            const monthData = {};
            filteredMappedData.forEach(it => {
                const m = it.monthDisplay || 'Unknown';
                const d = it.customerDistrict, g = it.grade;
                if (!monthData[m]) monthData[m] = {};
                if (!monthData[m][d]) monthData[m][d] = { Gold:0, Silver:0, Bronze:0, Grease:0, Hydraulic:0, DEF:0, Green:0, Other:0, totalL:0 };
                monthData[m][d][g] += it.liters;
                monthData[m][d].totalL += it.liters;
            });
            const months = Object.keys(monthData).sort((a,b)=> {
                const val = m => { let p=m.split(' '); if(p.length==2){let idx=monthNames.indexOf(p[0]); if(idx!==-1) return parseInt(p[1])*12+idx;} return 0; };
                return val(a)-val(b);
            });
            let html = `<h4>Monthly District-Wise Grade Analysis (Liters)</h4><p>${new Date().toLocaleString()}</p><p>Filter: ${getFilterInfo()}</p><div class="district-report-container">`;
            months.forEach(m => {
                let mTotalL = 0;
                Object.values(monthData[m]).forEach(dd => mTotalL += dd.totalL);
                html += `<div class="district-report-box"><h4><i class="fas fa-calendar-alt"></i> ${m}</h4><p>Total Liters: ${formatNumber(mTotalL)}</p>`;
                html += `<table class="monthly-report-table"><thead><tr><th>District</th><th>Gold</th><th>Silver</th><th>Bronze</th><th>Grease</th><th>Hyd</th><th>DEF</th><th>Green</th><th>Other</th><th>Total</th></tr></thead><tbody>`;
                Object.keys(monthData[m]).sort().forEach(d => {
                    const dd = monthData[m][d];
                    html += `<tr><td>${d}</td><td>${formatNumber(dd.Gold)}</td><td>${formatNumber(dd.Silver)}</td><td>${formatNumber(dd.Bronze)}</td><td>${formatNumber(dd.Grease)}</td><td>${formatNumber(dd.Hydraulic)}</td><td>${formatNumber(dd.DEF)}</td><td>${formatNumber(dd.Green)}</td><td>${formatNumber(dd.Other)}</td><td><strong>${formatNumber(dd.totalL)}</strong></td></tr>`;
                });
                html += `</tbody></table></div>`;
            });
            html += `</div>`;
            document.getElementById('reportContent').innerHTML = html;
            document.getElementById('reportContainer').style.display = 'block';
        }
        
        function generateGradeReport() {
            if (!filteredMappedData.length) { alert('No data'); return; }
            const gradeDist = { 
                Gold: {FRANKY:0, KYRPAD:0, 'OTHERS DISTRICT':0, totalL:0}, 
                Silver: {FRANKY:0, KYRPAD:0, 'OTHERS DISTRICT':0, totalL:0}, 
                Bronze: {FRANKY:0, KYRPAD:0, 'OTHERS DISTRICT':0, totalL:0},
                Grease: {FRANKY:0, KYRPAD:0, 'OTHERS DISTRICT':0, totalL:0}, 
                Hydraulic: {FRANKY:0, KYRPAD:0, 'OTHERS DISTRICT':0, totalL:0}, 
                DEF: {FRANKY:0, KYRPAD:0, 'OTHERS DISTRICT':0, totalL:0}, 
                Green: {FRANKY:0, KYRPAD:0, 'OTHERS DISTRICT':0, totalL:0}, 
                Other: {FRANKY:0, KYRPAD:0, 'OTHERS DISTRICT':0, totalL:0} 
            };
            
            filteredMappedData.forEach(it => {
                const g = it.grade, d = it.customerDistrict, l = it.liters;
                if (gradeDist[g] && gradeDist[g][d] !== undefined) {
                    gradeDist[g][d] += l;
                    gradeDist[g].totalL += l;
                }
            });
            
            let html = `<h4>Grade-Wise District Analysis (Liters)</h4><p>${new Date().toLocaleString()}</p><p>Filter: ${getFilterInfo()}</p>`;
            html += `<table class="report-table"><thead><tr><th>Grade</th><th>FRANKY</th><th>KYRPAD</th><th>OTHERS DISTRICT</th><th>Total L</th><th>%</th></tr></thead><tbody>`;
            let grandTotal = 0;
            ['Gold','Silver','Bronze','Grease','Hydraulic','DEF','Green','Other'].forEach(g => {
                if (gradeDist[g].totalL > 0) {
                    const pct = (gradeDist[g].totalL / (Object.values(gradeDist).reduce((s,o)=>s+o.totalL,0)) * 100).toFixed(1);
                    html += `<tr><td><strong>${g}</strong></td><td>${formatNumber(gradeDist[g].FRANKY)}</td><td>${formatNumber(gradeDist[g].KYRPAD)}</td><td>${formatNumber(gradeDist[g]['OTHERS DISTRICT'])}</td><td><strong>${formatNumber(gradeDist[g].totalL)}</strong></td><td>${pct}%</td></tr>`;
                    grandTotal += gradeDist[g].totalL;
                }
            });
            html += `<tr class="grand-total"><td><strong>GRAND TOTAL</strong></td><td>${formatNumber(gradeDist.Gold.FRANKY+gradeDist.Silver.FRANKY+gradeDist.Bronze.FRANKY+gradeDist.Grease.FRANKY+gradeDist.Hydraulic.FRANKY+gradeDist.DEF.FRANKY+gradeDist.Green.FRANKY+gradeDist.Other.FRANKY)}</td><td>${formatNumber(gradeDist.Gold.KYRPAD+gradeDist.Silver.KYRPAD+gradeDist.Bronze.KYRPAD+gradeDist.Grease.KYRPAD+gradeDist.Hydraulic.KYRPAD+gradeDist.DEF.KYRPAD+gradeDist.Green.KYRPAD+gradeDist.Other.KYRPAD)}</td><td>${formatNumber(gradeDist.Gold['OTHERS DISTRICT']+gradeDist.Silver['OTHERS DISTRICT']+gradeDist.Bronze['OTHERS DISTRICT']+gradeDist.Grease['OTHERS DISTRICT']+gradeDist.Hydraulic['OTHERS DISTRICT']+gradeDist.DEF['OTHERS DISTRICT']+gradeDist.Green['OTHERS DISTRICT']+gradeDist.Other['OTHERS DISTRICT'])}</td><td><strong>${formatNumber(grandTotal)}</strong></td><td>100%</td></tr>`;
            html += `</tbody></table>`;
            document.getElementById('reportContent').innerHTML = html;
            document.getElementById('reportContainer').style.display = 'block';
        }
        
        // ==================== FIXED: EXPORT MONTHLY REPORT TO EXCEL (FILTER-BASED) ====================
        
        function exportMonthlyReportToExcel() {
            if (!filteredMappedData.length) { 
                alert('No filtered data to export. Please apply filters or load data first.'); 
                return; 
            }
            
            // Recalculate month data from filtered data only
            const monthData = {};
            filteredMappedData.forEach(it => {
                const m = it.monthDisplay || 'Unknown';
                const d = it.customerDistrict;
                const g = it.grade;
                const l = it.liters;
                const q = it.qnty;
                
                if (!monthData[m]) {
                    monthData[m] = {
                        districts: {},
                        totalL: 0,
                        totalQ: 0
                    };
                }
                
                if (!monthData[m].districts[d]) {
                    monthData[m].districts[d] = {
                        Gold: 0, Silver: 0, Bronze: 0, Grease: 0, Hydraulic: 0, DEF: 0, Green: 0, Other: 0,
                        totalL: 0, totalQ: 0
                    };
                }
                
                monthData[m].districts[d][g] += l;
                monthData[m].districts[d].totalL += l;
                monthData[m].districts[d].totalQ += q;
                monthData[m].totalL += l;
                monthData[m].totalQ += q;
            });
            
            const months = Object.keys(monthData).sort((a,b)=> {
                const val = m => { 
                    let p = m.split(' '); 
                    if (p.length == 2) {
                        let idx = monthNames.indexOf(p[0]); 
                        if (idx !== -1) return parseInt(p[1]) * 12 + idx;
                    } 
                    return 0; 
                };
                return val(a) - val(b);
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // ===== SHEET 1: Monthly Summary =====
            const summaryData = [
                ['MONTHLY DISTRICT-WISE GRADE ANALYSIS - FILTERED DATA'],
                [`Generated: ${new Date().toLocaleString()}`],
                [`Filter Applied: ${getFilterInfo()}`],
                [`Total Filtered Rows: ${filteredMappedData.length}`],
                [],
                ['MONTHLY SUMMARY (Liters)'],
                ['Month', 'FRANKY', 'KYRPAD', 'OTHERS DISTRICT', 'TOTAL LITERS', 'TOTAL QTY']
            ];
            
            let grandTotalL = 0, grandTotalQ = 0;
            
            months.forEach(m => {
                let frankyL = 0, kyrpadL = 0, othersL = 0;
                
                Object.keys(monthData[m].districts).forEach(d => {
                    if (d === 'FRANKY') frankyL += monthData[m].districts[d].totalL;
                    else if (d === 'KYRPAD') kyrpadL += monthData[m].districts[d].totalL;
                    else othersL += monthData[m].districts[d].totalL;
                });
                
                summaryData.push([
                    m,
                    formatNumber(frankyL),
                    formatNumber(kyrpadL),
                    formatNumber(othersL),
                    formatNumber(monthData[m].totalL),
                    formatNumber(monthData[m].totalQ)
                ]);
                
                grandTotalL += monthData[m].totalL;
                grandTotalQ += monthData[m].totalQ;
            });
            
            summaryData.push([
                'GRAND TOTAL',
                formatNumber(summaryData.slice(6).reduce((sum, row) => sum + parseFloat(row[1].replace(/,/g, '')) || 0, 0)),
                formatNumber(summaryData.slice(6).reduce((sum, row) => sum + parseFloat(row[2].replace(/,/g, '')) || 0, 0)),
                formatNumber(summaryData.slice(6).reduce((sum, row) => sum + parseFloat(row[3].replace(/,/g, '')) || 0, 0)),
                formatNumber(grandTotalL),
                formatNumber(grandTotalQ)
            ]);
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            
            // Set column widths for summary
            summaryWs['!cols'] = [
                { wch: 15 }, // Month
                { wch: 15 }, // FRANKY
                { wch: 15 }, // KYRPAD
                { wch: 20 }, // OTHERS DISTRICT
                { wch: 15 }, // TOTAL LITERS
                { wch: 15 }  // TOTAL QTY
            ];
            
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Monthly Summary');
            
            // ===== SHEET 2: Detailed Monthly Breakdown =====
            const detailData = [
                ['MONTHLY DETAILED BREAKDOWN - FILTERED DATA'],
                [`Generated: ${new Date().toLocaleString()}`],
                [`Filter Applied: ${getFilterInfo()}`],
                [],
            ];
            
            months.forEach(m => {
                detailData.push([`MONTH: ${m}`]);
                detailData.push(['District', 'Gold', 'Silver', 'Bronze', 'Grease', 'Hydraulic', 'DEF', 'Green', 'Other', 'Total Liters', 'Total Qty']);
                
                const districts = Object.keys(monthData[m].districts).sort();
                
                districts.forEach(d => {
                    const dd = monthData[m].districts[d];
                    detailData.push([
                        d,
                        formatNumber(dd.Gold),
                        formatNumber(dd.Silver),
                        formatNumber(dd.Bronze),
                        formatNumber(dd.Grease),
                        formatNumber(dd.Hydraulic),
                        formatNumber(dd.DEF),
                        formatNumber(dd.Green),
                        formatNumber(dd.Other),
                        formatNumber(dd.totalL),
                        formatNumber(dd.totalQ)
                    ]);
                });
                
                detailData.push([
                    'MONTH TOTAL',
                    formatNumber(districts.reduce((sum, d) => sum + monthData[m].districts[d].Gold, 0)),
                    formatNumber(districts.reduce((sum, d) => sum + monthData[m].districts[d].Silver, 0)),
                    formatNumber(districts.reduce((sum, d) => sum + monthData[m].districts[d].Bronze, 0)),
                    formatNumber(districts.reduce((sum, d) => sum + monthData[m].districts[d].Grease, 0)),
                    formatNumber(districts.reduce((sum, d) => sum + monthData[m].districts[d].Hydraulic, 0)),
                    formatNumber(districts.reduce((sum, d) => sum + monthData[m].districts[d].DEF, 0)),
                    formatNumber(districts.reduce((sum, d) => sum + monthData[m].districts[d].Green, 0)),
                    formatNumber(districts.reduce((sum, d) => sum + monthData[m].districts[d].Other, 0)),
                    formatNumber(monthData[m].totalL),
                    formatNumber(monthData[m].totalQ)
                ]);
                detailData.push([]); // Empty row between months
            });
            
            const detailWs = XLSX.utils.aoa_to_sheet(detailData);
            
            // Set column widths for detail
            detailWs['!cols'] = [
                { wch: 20 }, // District
                { wch: 12 }, // Gold
                { wch: 12 }, // Silver
                { wch: 12 }, // Bronze
                { wch: 12 }, // Grease
                { wch: 12 }, // Hydraulic
                { wch: 12 }, // DEF
                { wch: 12 }, // Green
                { wch: 12 }, // Other
                { wch: 15 }, // Total Liters
                { wch: 15 }  // Total Qty
            ];
            
            XLSX.utils.book_append_sheet(wb, detailWs, 'Monthly Detail');
            
            // ===== SHEET 3: Filter Information =====
            const filterData = [
                ['FILTER INFORMATION'],
                [`Generated: ${new Date().toLocaleString()}`],
                [],
                ['Applied Filters:'],
                ['Customer Names:', selectedCustomerNames.length ? selectedCustomerNames.join(', ') : 'All'],
                ['Customer Groups:', selectedCustomerGroups.length ? selectedCustomerGroups.join(', ') : 'All'],
                ['Districts:', selectedDistricts.length ? selectedDistricts.join(', ') : 'All'],
                ['Months:', selectedMonths.length ? selectedMonths.join(', ') : 'All'],
                ['Grades:', selectedGrades.length ? selectedGrades.join(', ') : 'All'],
                [],
                ['Data Statistics:'],
                ['Total Rows (Filtered):', filteredMappedData.length],
                ['Total Rows (All):', currentMappedData.length],
                [],
                ['Grade Totals (Filtered):'],
                ['Gold:', formatNumber(filteredMappedData.filter(d => d.grade === 'Gold').reduce((sum, d) => sum + d.liters, 0)) + ' L'],
                ['Silver:', formatNumber(filteredMappedData.filter(d => d.grade === 'Silver').reduce((sum, d) => sum + d.liters, 0)) + ' L'],
                ['Bronze:', formatNumber(filteredMappedData.filter(d => d.grade === 'Bronze').reduce((sum, d) => sum + d.liters, 0)) + ' L'],
                ['Grease:', formatNumber(filteredMappedData.filter(d => d.grade === 'Grease').reduce((sum, d) => sum + d.liters, 0)) + ' L'],
                ['Hydraulic:', formatNumber(filteredMappedData.filter(d => d.grade === 'Hydraulic').reduce((sum, d) => sum + d.liters, 0)) + ' L'],
                ['DEF:', formatNumber(filteredMappedData.filter(d => d.grade === 'DEF').reduce((sum, d) => sum + d.liters, 0)) + ' L'],
                ['Green:', formatNumber(filteredMappedData.filter(d => d.grade === 'Green').reduce((sum, d) => sum + d.liters, 0)) + ' L'],
                ['Other:', formatNumber(filteredMappedData.filter(d => d.grade === 'Other').reduce((sum, d) => sum + d.liters, 0)) + ' L'],
                [],
                ['District Totals (Filtered):'],
                ['FRANKY:', formatNumber(filteredMappedData.filter(d => d.customerDistrict === 'FRANKY').reduce((sum, d) => sum + d.liters, 0)) + ' L'],
                ['KYRPAD:', formatNumber(filteredMappedData.filter(d => d.customerDistrict === 'KYRPAD').reduce((sum, d) => sum + d.liters, 0)) + ' L'],
                ['OTHERS DISTRICT:', formatNumber(filteredMappedData.filter(d => d.customerDistrict === 'OTHERS DISTRICT').reduce((sum, d) => sum + d.liters, 0)) + ' L']
            ];
            
            const filterWs = XLSX.utils.aoa_to_sheet(filterData);
            filterWs['!cols'] = [{ wch: 25 }, { wch: 50 }];
            XLSX.utils.book_append_sheet(wb, filterWs, 'Filter Info');
            
            // Export file
            const fileName = `monthly_report_filtered_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        // ==================== UPDATED: EXPORT REPORT TO EXCEL (NOW DETECTS REPORT TYPE) ====================
        
        function exportReportToExcel() {
            if (document.getElementById('reportContainer').style.display === 'none') { 
                alert('Please generate a report first.'); 
                return; 
            }
            
            // Check what report is currently displayed
            const reportTitle = document.getElementById('reportContent').querySelector('h4')?.innerText || '';
            
            if (reportTitle.toLowerCase().includes('monthly')) {
                // Use the dedicated monthly report export that respects filters
                exportMonthlyReportToExcel();
            } else {
                // For other report types, use the generic export
                exportGenericReportToExcel();
            }
        }
        
        function exportGenericReportToExcel() {
            const reportContent = document.getElementById('reportContent');
            const reportTables = reportContent.querySelectorAll('table');
            
            if (reportTables.length === 0) {
                alert('No table found in report to export.');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const reportTitle = reportContent.querySelector('h4')?.innerText || 'Report';
            const dateInfo = reportContent.querySelector('p')?.innerText || new Date().toLocaleString();
            
            // Process each table as a separate sheet
            reportTables.forEach((table, index) => {
                const sheetData = [];
                
                // Extract headers
                const headers = [];
                const headerRow = table.querySelector('thead tr');
                if (headerRow) {
                    headerRow.querySelectorAll('th').forEach(th => {
                        headers.push(th.innerText.trim());
                    });
                    sheetData.push(headers);
                }
                
                // Extract body rows
                table.querySelectorAll('tbody tr').forEach(row => {
                    const rowData = [];
                    row.querySelectorAll('td').forEach(td => {
                        rowData.push(td.innerText.trim());
                    });
                    sheetData.push(rowData);
                });
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(sheetData);
                
                // Auto-size columns
                const colWidths = [];
                for (let i = 0; i < headers.length; i++) {
                    let maxLen = headers[i]?.length || 10;
                    for (let j = 1; j < Math.min(sheetData.length, 50); j++) {
                        if (sheetData[j] && sheetData[j][i]) {
                            maxLen = Math.max(maxLen, sheetData[j][i].toString().length);
                        }
                    }
                    colWidths.push({ wch: Math.min(maxLen + 2, 30) });
                }
                ws['!cols'] = colWidths;
                
                // Sheet name
                let sheetName = 'Report';
                if (reportTitle.toLowerCase().includes('district')) sheetName = 'District Report';
                else if (reportTitle.toLowerCase().includes('grade')) sheetName = 'Grade Analysis';
                else sheetName = `Report ${index + 1}`;
                
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });
            
            // Add filter info sheet
            const infoData = [
                ['REPORT INFORMATION'],
                ['Report Type:', reportTitle],
                ['Generated:', dateInfo],
                ['Filter:', getFilterInfo()],
                [''],
                ['DATA SUMMARY (Filtered)'],
                ['Total Rows:', filteredMappedData.length],
                [''],
                ['Grade Totals (Liters):'],
                ['Gold:', formatNumber(filteredMappedData.filter(d => d.grade === 'Gold').reduce((sum, d) => sum + d.liters, 0))],
                ['Silver:', formatNumber(filteredMappedData.filter(d => d.grade === 'Silver').reduce((sum, d) => sum + d.liters, 0))],
                ['Bronze:', formatNumber(filteredMappedData.filter(d => d.grade === 'Bronze').reduce((sum, d) => sum + d.liters, 0))],
                ['Grease:', formatNumber(filteredMappedData.filter(d => d.grade === 'Grease').reduce((sum, d) => sum + d.liters, 0))],
                ['Hydraulic:', formatNumber(filteredMappedData.filter(d => d.grade === 'Hydraulic').reduce((sum, d) => sum + d.liters, 0))],
                ['DEF:', formatNumber(filteredMappedData.filter(d => d.grade === 'DEF').reduce((sum, d) => sum + d.liters, 0))],
                ['Green:', formatNumber(filteredMappedData.filter(d => d.grade === 'Green').reduce((sum, d) => sum + d.liters, 0))],
                ['Other:', formatNumber(filteredMappedData.filter(d => d.grade === 'Other').reduce((sum, d) => sum + d.liters, 0))],
                [''],
                ['District Totals (Liters):'],
                ['FRANKY:', formatNumber(filteredMappedData.filter(d => d.customerDistrict === 'FRANKY').reduce((sum, d) => sum + d.liters, 0))],
                ['KYRPAD:', formatNumber(filteredMappedData.filter(d => d.customerDistrict === 'KYRPAD').reduce((sum, d) => sum + d.liters, 0))],
                ['OTHERS DISTRICT:', formatNumber(filteredMappedData.filter(d => d.customerDistrict === 'OTHERS DISTRICT').reduce((sum, d) => sum + d.liters, 0))]
            ];
            
            const infoWs = XLSX.utils.aoa_to_sheet(infoData);
            XLSX.utils.book_append_sheet(wb, infoWs, 'Report Info');
            
            const fileName = `report_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        // ==================== TEXT EXPORT FUNCTIONS ====================
        
        function exportRawDataToText() {
            if (!currentMappedData.length) { 
                alert('No data to export'); 
                return; 
            }
            
            const dataToExport = filteredMappedData.length ? filteredMappedData : currentMappedData;
            
            let textContent = "========================================\n";
            textContent += "     MULTI-GRADE SKU DATA EXPORT\n";
            textContent += "========================================\n\n";
            textContent += `Generated: ${new Date().toLocaleString()}\n`;
            textContent += `Total Rows: ${dataToExport.length}\n`;
            textContent += `Filters Applied: ${getFilterInfo()}\n\n`;
            
            textContent += "--------------------------------------------------------------------------------------------------------------------------------------------------------\n";
            textContent += "SKU Code       | SKU Name                                               | Qnty   | Liters | Customer Name      | Group     | District        | Month       | Grade\n";
            textContent += "--------------------------------------------------------------------------------------------------------------------------------------------------------\n";
            
            dataToExport.forEach(item => {
                const skuCode = (item.skuCode || '').padEnd(14).substring(0,14);
                const skuName = (item.skuName || '').padEnd(52).substring(0,52);
                const qnty = (formatNumber(item.qnty) || '0').padStart(6);
                const liters = (formatNumber(item.liters) || '0').padStart(6);
                const custName = (item.customerName || '').padEnd(18).substring(0,18);
                const custGroup = (item.customerGroup || '').padEnd(10).substring(0,10);
                const district = (item.customerDistrict || '').padEnd(14).substring(0,14);
                const month = (item.monthDisplay || '').padEnd(11).substring(0,11);
                const grade = (item.grade || '').padEnd(8).substring(0,8);
                
                textContent += `${skuCode} | ${skuName} | ${qnty} | ${liters} | ${custName} | ${custGroup} | ${district} | ${month} | ${grade}\n`;
            });
            
            textContent += "--------------------------------------------------------------------------------------------------------------------------------------------------------\n\n";
            
            // Add summary statistics
            textContent += "========================================\n";
            textContent += "           SUMMARY STATISTICS\n";
            textContent += "========================================\n\n";
            
            textContent += "GRADE TOTALS:\n";
            textContent += `  Gold:      ${formatNumber(totalGoldQnty)} Qty, ${formatNumber(totalGoldLiters)} Liters\n`;
            textContent += `  Silver:    ${formatNumber(totalSilverQnty)} Qty, ${formatNumber(totalSilverLiters)} Liters\n`;
            textContent += `  Bronze:    ${formatNumber(totalBronzeQnty)} Qty, ${formatNumber(totalBronzeLiters)} Liters\n`;
            textContent += `  Grease:    ${formatNumber(totalGreaseQnty)} Qty, ${formatNumber(totalGreaseLiters)} Liters\n`;
            textContent += `  Hydraulic: ${formatNumber(totalHydraulicQnty)} Qty, ${formatNumber(totalHydraulicLiters)} Liters\n`;
            textContent += `  DEF:       ${formatNumber(totalDefQnty)} Qty, ${formatNumber(totalDefLiters)} Liters\n`;
            textContent += `  Green:     ${formatNumber(totalGreenQnty)} Qty, ${formatNumber(totalGreenLiters)} Liters\n`;
            textContent += `  Other:     ${formatNumber(totalOtherQnty)} Qty, ${formatNumber(totalOtherLiters)} Liters\n\n`;
            
            textContent += "DISTRICT TOTALS:\n";
            textContent += `  FRANKY:          ${formatNumber(totalFrankyQnty)} Qty, ${formatNumber(totalFrankyLiters)} Liters\n`;
            textContent += `  KYRPAD:          ${formatNumber(totalKyrpadQnty)} Qty, ${formatNumber(totalKyrpadLiters)} Liters\n`;
            textContent += `  OTHERS DISTRICT: ${formatNumber(totalOthersDistrictQnty)} Qty, ${formatNumber(totalOthersDistrictLiters)} Liters\n\n`;
            
            textContent += `SKU Validation:\n`;
            textContent += `  Total Rows Processed: ${totalRows}\n`;
            textContent += `  SKU Matches by Grade:\n`;
            textContent += `    Gold: ${goldSkuMatches}, Silver: ${silverSkuMatches}, Bronze: ${bronzeSkuMatches}, Grease: ${greaseSkuMatches}\n`;
            textContent += `    Hydraulic: ${hydraulicSkuMatches}, DEF: ${defSkuMatches}, Green: ${greenSkuMatches}, Other: ${otherSkuMatches}\n`;
            textContent += `  Names Corrected: ${nameCorrections}\n`;
            textContent += `  Unknown SKUs: ${currentMappedData.filter(it=>!it.isKnownSku && it.skuCode).length}\n\n`;
            
            textContent += "========================================\n";
            textContent += "           END OF REPORT\n";
            textContent += "========================================\n";
            
            downloadTextFile(textContent, `sku_data_export_${new Date().toISOString().slice(0,10)}.txt`);
        }
        
        function exportReportToText() {
            if (document.getElementById('reportContainer').style.display === 'none') {
                alert('Please generate a report first.');
                return;
            }
            
            const reportContent = document.getElementById('reportContent').innerText || 
                                 document.getElementById('reportContent').textContent;
            
            let textContent = "========================================\n";
            textContent += "         MULTI-GRADE SKU REPORT\n";
            textContent += "========================================\n\n";
            textContent += `Generated: ${new Date().toLocaleString()}\n`;
            textContent += `Filter: ${getFilterInfo()}\n\n`;
            textContent += reportContent.replace(/\s+/g, ' ').trim();
            textContent += "\n\n========================================\n";
            textContent += "           END OF REPORT\n";
            textContent += "========================================\n";
            
            downloadTextFile(textContent, `sku_report_${new Date().toISOString().slice(0,10)}.txt`);
        }
        
        function downloadTextFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }
        
        // ==================== EXCEL EXPORT (RAW DATA) ====================
        
        function exportToExcel() {
            if (!currentMappedData.length) { 
                alert('No data to export. Please upload and process a file first.'); 
                return; 
            }
            
            const dataToExport = filteredMappedData.length ? filteredMappedData : currentMappedData;
            
            // Prepare worksheet data
            const wsData = [
                ['SKU Code', 'SKU Name', 'Quantity', 'Liters', 'Customer Name', 'Customer Group', 
                 'Original District', 'Reclassified District', 'Month', 'Grade', 'Name Validated']
            ];
            
            dataToExport.forEach(item => {
                wsData.push([
                    item.skuCode || '',
                    item.skuName || '',
                    item.qnty || 0,
                    item.liters || 0,
                    item.customerName || '',
                    item.customerGroup || '',
                    item.customerDistrictOriginal || '',
                    item.customerDistrict || '',
                    item.monthDisplay || '',
                    item.grade || '',
                    item.nameValidated ? 'Yes' : 'No'
                ]);
            });
            
            // Add summary section
            wsData.push([]);
            wsData.push(['SUMMARY STATISTICS']);
            wsData.push(['Generated:', new Date().toLocaleString()]);
            wsData.push(['Total Rows:', totalRows]);
            wsData.push([]);
            wsData.push(['GRADE TOTALS', 'Quantity', 'Liters']);
            wsData.push(['Gold', totalGoldQnty, totalGoldLiters]);
            wsData.push(['Silver', totalSilverQnty, totalSilverLiters]);
            wsData.push(['Bronze', totalBronzeQnty, totalBronzeLiters]);
            wsData.push(['Grease', totalGreaseQnty, totalGreaseLiters]);
            wsData.push(['Hydraulic', totalHydraulicQnty, totalHydraulicLiters]);
            wsData.push(['DEF', totalDefQnty, totalDefLiters]);
            wsData.push(['Green', totalGreenQnty, totalGreenLiters]);
            wsData.push(['Other', totalOtherQnty, totalOtherLiters]);
            wsData.push([]);
            wsData.push(['DISTRICT TOTALS', 'Quantity', 'Liters']);
            wsData.push(['FRANKY', totalFrankyQnty, totalFrankyLiters]);
            wsData.push(['KYRPAD', totalKyrpadQnty, totalKyrpadLiters]);
            wsData.push(['OTHERS DISTRICT', totalOthersDistrictQnty, totalOthersDistrictLiters]);
            wsData.push([]);
            wsData.push(['SKU VALIDATION']);
            wsData.push(['Gold SKU Matches:', goldSkuMatches]);
            wsData.push(['Silver SKU Matches:', silverSkuMatches]);
            wsData.push(['Bronze SKU Matches:', bronzeSkuMatches]);
            wsData.push(['Grease SKU Matches:', greaseSkuMatches]);
            wsData.push(['Hydraulic SKU Matches:', hydraulicSkuMatches]);
            wsData.push(['DEF SKU Matches:', defSkuMatches]);
            wsData.push(['Green SKU Matches:', greenSkuMatches]);
            wsData.push(['Other SKU Matches:', otherSkuMatches]);
            wsData.push(['Names Corrected:', nameCorrections]);
            wsData.push(['Unknown SKUs:', currentMappedData.filter(it=>!it.isKnownSku && it.skuCode).length]);
            
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Auto-size columns (approximate)
            const colWidths = [];
            for (let i = 0; i < wsData[0].length; i++) {
                let maxLen = 10;
                for (let j = 0; j < Math.min(wsData.length, 100); j++) {
                    if (wsData[j] && wsData[j][i]) {
                        maxLen = Math.max(maxLen, wsData[j][i].toString().length);
                    }
                }
                colWidths.push({ wch: Math.min(maxLen + 2, 50) });
            }
            ws['!cols'] = colWidths;
            
            XLSX.utils.book_append_sheet(wb, ws, 'SKU Data');
            
            // Add summary sheet
            const summaryData = [
                ['MULTI-GRADE SKU TRACKING - SUMMARY REPORT'],
                ['Generated:', new Date().toLocaleString()],
                [''],
                ['GRADE ANALYSIS'],
                ['Grade', 'Quantity', 'Liters', 'SKU Matches'],
                ['Gold', totalGoldQnty, totalGoldLiters, goldSkuMatches],
                ['Silver', totalSilverQnty, totalSilverLiters, silverSkuMatches],
                ['Bronze', totalBronzeQnty, totalBronzeLiters, bronzeSkuMatches],
                ['Grease', totalGreaseQnty, totalGreaseLiters, greaseSkuMatches],
                ['Hydraulic', totalHydraulicQnty, totalHydraulicLiters, hydraulicSkuMatches],
                ['DEF', totalDefQnty, totalDefLiters, defSkuMatches],
                ['Green', totalGreenQnty, totalGreenLiters, greenSkuMatches],
                ['Other', totalOtherQnty, totalOtherLiters, otherSkuMatches],
                [''],
                ['DISTRICT ANALYSIS'],
                ['District', 'Quantity', 'Liters'],
                ['FRANKY', totalFrankyQnty, totalFrankyLiters],
                ['KYRPAD', totalKyrpadQnty, totalKyrpadLiters],
                ['OTHERS DISTRICT', totalOthersDistrictQnty, totalOthersDistrictLiters],
                [''],
                ['FILTER INFORMATION'],
                ['Filter Status:', getFilterInfo()],
                ['Showing:', filteredMappedData.length + ' of ' + currentMappedData.length + ' rows']
            ];
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
            
            // Export file
            const fileName = `sku_data_export_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        // ==================== PDF EXPORT ====================
        
        function exportToPDF() {
            if (!currentMappedData.length) { 
                alert('No data to export'); 
                return; 
            }
            alert('PDF export for raw data - Full implementation available with jsPDF AutoTable');
        }
        
        function exportReportToPDF() {
            if (document.getElementById('reportContainer').style.display === 'none') {
                alert('Generate a report first');
                return;
            }
            const element = document.getElementById('reportContainer');
            html2canvas(element, {
                scale: 2,
                backgroundColor: '#ffffff',
                logging: false,
                windowWidth: 1200
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'px',
                    format: [canvas.width * 0.75, canvas.height * 0.75]
                });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width * 0.75, canvas.height * 0.75);
                pdf.save(`report_${new Date().toISOString().slice(0,10)}.pdf`);
            }).catch(err => {
                console.error(err);
                alert('PDF export failed');
            });
        }
        
        // ==================== PNG EXPORT ====================
        
        function exportReportAsPNG() {
            if (document.getElementById('reportContainer').style.display === 'none') {
                alert('Please generate a report first.');
                return;
            }
            document.getElementById('reportModal').style.display = 'block';
        }
        
        function captureReportAsPNG(type) {
            closeReportModal();
            let elementToCapture;
            if (type === 'full') {
                elementToCapture = document.getElementById('reportContainer');
            } else {
                if (type === 'district') generateDistrictReport();
                else if (type === 'monthly') generateMonthlyReport();
                else if (type === 'grade') generateGradeReport();
                elementToCapture = document.getElementById('reportContent');
            }
            
            const cloneContainer = document.getElementById('exportPreviewContainer');
            cloneContainer.innerHTML = '';
            const clone = elementToCapture.cloneNode(true);
            clone.style.width = '1200px';
            clone.style.background = 'white';
            clone.style.padding = '30px';
            clone.style.margin = '0';
            clone.style.boxSizing = 'border-box';
            cloneContainer.appendChild(clone);
            
            html2canvas(clone, {
                scale: 2.5,
                backgroundColor: '#ffffff',
                allowTaint: false,
                useCORS: true,
                logging: false,
                windowWidth: 1200,
                windowHeight: clone.scrollHeight
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${type}_report_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                cloneContainer.innerHTML = '';
            }).catch(err => {
                console.error(err);
                alert('PNG export failed');
                cloneContainer.innerHTML = '';
            });
        }
        
        // ==================== UTILITIES ====================
        function formatNumber(num) {
            if (isNaN(num)) return '0';
            return num.toLocaleString('en-US', { minimumFractionDigits:0, maximumFractionDigits:2 });
        }
        
        function getFilterInfo() {
            let parts = [];
            if (selectedCustomerNames.length) parts.push(`Customers:${selectedCustomerNames.length}`);
            else parts.push('All Customers');
            if (selectedCustomerGroups.length) parts.push(`Groups:${selectedCustomerGroups.length}`);
            else parts.push('All Groups');
            if (selectedDistricts.length) parts.push(`Districts:${selectedDistricts.length}`);
            else parts.push('All Districts');
            if (selectedMonths.length) parts.push(`Months:${selectedMonths.length}`);
            else parts.push('All Months');
            if (selectedGrades.length) parts.push(`Grades:${selectedGrades.length}`);
            else parts.push('All Grades');
            return parts.join(' | ');
        }
        
        function resetForm() {
            document.getElementById('fileInput').value = '';
            ['skuCodeMap','skuNameMap','qntyMap','litersMap','customerNameMap','customerGroupMap','districtMap','monthMap'].forEach(id => document.getElementById(id).selectedIndex=0);
            ['customerNameFilterDropdown','customerGroupFilterDropdown','districtFilterDropdown','monthFilterDropdown','gradeFilterDropdown'].forEach(id => document.getElementById(id).innerHTML='');
            ['customerNameSelectedCount','customerGroupSelectedCount','districtSelectedCount','monthSelectedCount','gradeSelectedCount'].forEach(id => document.getElementById(id).textContent='0');
            selectedCustomerNames=[]; selectedCustomerGroups=[]; selectedDistricts=[]; selectedMonths=[]; selectedGrades=[]; currentOpenDropdown=null;
            document.getElementById('previewTableBody').innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#999;"><i class="fas fa-file-excel" style="font-size:2rem;"></i><br>Upload an Excel file to preview data</td></tr>';
            document.querySelector('#previewTable thead tr').innerHTML = '<th>SKU Code</th><th>SKU Name</th><th>Qnty</th><th>Liters</th><th>Customer Name</th><th>Customer Group</th><th>District (Reclassified)</th><th>Month (MMM YYYY)</th><th>Grade</th>';
            document.getElementById('totalsContainer').style.display = 'none';
            document.getElementById('validationResult').style.display = 'none';
            document.getElementById('filtersSection').style.display = 'none';
            document.getElementById('districtClassificationInfo').style.display = 'none';
            document.getElementById('reportContainer').style.display = 'none';
            document.getElementById('previewStatus').innerHTML = '<i class="fas fa-clock"></i> No file loaded';
            document.getElementById('previewStatus').className = 'status-indicator status-pending';
            currentMappedData = []; filteredMappedData = [];
        }
        
        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }
        
        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) closeReportModal();
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeSkuList();
            const dropArea = document.querySelector('.file-upload-area');
            ['dragenter','dragover','dragleave','drop'].forEach(ev => dropArea.addEventListener(ev, e => e.preventDefault()));
            ['dragenter','dragover'].forEach(ev => dropArea.addEventListener(ev, () => { dropArea.style.backgroundColor = '#fffce6'; dropArea.style.borderColor = '#c19500'; }));
            ['dragleave','drop'].forEach(ev => dropArea.addEventListener(ev, () => { dropArea.style.backgroundColor = '#fffef5'; dropArea.style.borderColor = '#daa520'; }));
            dropArea.addEventListener('drop', function(e) {
                const files = e.dataTransfer.files;
                if (files.length) {
                    document.getElementById('fileInput').files = files;
                    document.getElementById('fileInput').dispatchEvent(new Event('change'));
                }
            });
            
            document.addEventListener('click', function(ev) {
                if (!ev.target.closest('.multi-select-container') && !ev.target.closest('button')) {
                    document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('show'));
                    currentOpenDropdown = null;
                }
            });
        });
    </script>
</body>
</html>